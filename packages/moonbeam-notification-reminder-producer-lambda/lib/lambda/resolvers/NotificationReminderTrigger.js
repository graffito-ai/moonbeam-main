"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.triggerNotificationReminder = void 0;
const moonbeam_models_1 = require("@moonbeam/moonbeam-models");
const client_sns_1 = require("@aws-sdk/client-sns");
/**
 * Function used to handle the daily notification reminder trigger, by first
 * determining whether a notification reminder needs to be sent out, and by
 * kick-starting that process for any applicable users, accordingly.
 */
const triggerNotificationReminder = async () => {
    try {
        // retrieving the current function region
        const region = process.env.AWS_REGION;
        /**
         * The overall notification reminder cron triggering, will be made up of the following steps:
         *
         * 1) Call the getNotificationReminders AppSync Query API in order to:
         *    - get any ACTIVE REMINDERS
         *    - for any ACTIVE reminders, sort through the ones that need to get triggered
         *
         * 2) For the reminders that are of:
         *    - CARD_LINKING_REMINDER type, call the getUsersWithNoCards
         *    AppSync Query API, in order to get all users to send notification reminders to.
         *    - for any other types, this is TBD.
         *
         * 3) For each applicable user from step 2) drop a message into the appropriate SNS topic.
         *
         * 4) Once all users have been notified, then update the card linking reminder accordingly,
         * by calling the updateNotificationReminder AppSync Mutation API.
         *
         */
        const moonbeamClient = new moonbeam_models_1.MoonbeamClient(process.env.ENV_NAME, region);
        // 1) Call the getNotificationReminders Moonbeam AppSync Query API endpoint.
        const notificationReminders = await moonbeamClient.getNotificationReminders();
        // check to see if the get notification reminders call was successful or not.
        if (notificationReminders !== null && notificationReminders !== undefined && !notificationReminders.errorMessage &&
            !notificationReminders.errorType && notificationReminders.data !== null && notificationReminders.data !== undefined &&
            notificationReminders.data.length !== 0) {
            // filter through each ACTIVE notification reminder
            let activeReminderCount = 0;
            for (const reminder of notificationReminders.data) {
                if (reminder.notificationReminderStatus == moonbeam_models_1.NotificationReminderStatus.Active) {
                    //  sort through the ones that need to get triggered
                    const nextTriggerDate = new Date(Date.parse(reminder.nextTriggerAt));
                    const currentDate = new Date(Date.now());
                    if (nextTriggerDate.getDate() === currentDate.getDate() && nextTriggerDate.getMonth() === currentDate.getMonth() &&
                        nextTriggerDate.getFullYear() === currentDate.getFullYear()) {
                        switch (reminder.notificationReminderType) {
                            case moonbeam_models_1.NotificationReminderType.CardLinkingReminder:
                                console.log(`__________________________________________________________________________________________________________________________________`);
                                console.log(`Found new ACTIVE notification reminder ${reminder.id} of type ${moonbeam_models_1.NotificationReminderType.CardLinkingReminder}`);
                                // 2) For any ACTIVE reminders of type CARD_LINKING_REMINDER, call the getUsersWithNoCards Moonbeam AppSync Query API endpoint.
                                const usersWithNoCards = await moonbeamClient.getUsersWithNoCards();
                                // check if the get users with no card call was successful or not.
                                if (usersWithNoCards !== null && usersWithNoCards !== undefined && !usersWithNoCards.errorMessage &&
                                    !usersWithNoCards.errorType && usersWithNoCards.data !== null && usersWithNoCards.data !== undefined &&
                                    usersWithNoCards.data.length !== 0) {
                                    // 3) For each applicable user from step 2) drop a message into the appropriate SNS topic.
                                    let successfulUserMessagesSent = 0;
                                    for (const ineligibleUser of usersWithNoCards.data) {
                                        // initializing the SNS Client
                                        const snsClient = new client_sns_1.SNSClient({ region: region });
                                        /**
                                         * drop the ineligible user input as a message to the notification reminder processing topic
                                         */
                                        const userDetailsForNotifications = {
                                            id: ineligibleUser.id,
                                            email: ineligibleUser.email,
                                            firstName: ineligibleUser.firstName,
                                            lastName: ineligibleUser.lastName,
                                            notificationChannelType: reminder.notificationChannelType,
                                            notificationType: moonbeam_models_1.NotificationType.CardLinkingReminder
                                        };
                                        const notificationReminderReceipt = await snsClient.send(new client_sns_1.PublishCommand({
                                            TopicArn: process.env.NOTIFICATION_REMINDER_PROCESSING_TOPIC_ARN,
                                            Message: JSON.stringify(userDetailsForNotifications),
                                            /**
                                             * the message group id, will be represented by the Moonbeam internal user id, so that we can group the notification reminder update messages for a particular
                                             * user id, and sort them in the FIFO processing topic accordingly.
                                             */
                                            MessageGroupId: ineligibleUser.id
                                        }));
                                        // ensure that the notification reminder message was properly sent to the appropriate processing topic
                                        if (notificationReminderReceipt !== null && notificationReminderReceipt !== undefined && notificationReminderReceipt.MessageId &&
                                            notificationReminderReceipt.MessageId.length !== 0 && notificationReminderReceipt.SequenceNumber && notificationReminderReceipt.SequenceNumber.length !== 0) {
                                            // the notification reminder message has been successfully dropped into the topic, and will be picked up by the notification reminder consumer
                                            console.log(`Notification reminder successfully sent to topic for processing with receipt information: ${notificationReminderReceipt.MessageId} ${notificationReminderReceipt.SequenceNumber}`);
                                            // increase the number of messages sent to the topic
                                            successfulUserMessagesSent += 1;
                                        }
                                        else {
                                            /**
                                             * no need for further actions, since this error will be logged and nothing will execute further.
                                             * in the future we might need some alerts and metrics emitting here
                                             */
                                            console.log(`Unexpected error while sending the notification reminder for user ${ineligibleUser.id}`);
                                        }
                                    }
                                    // check if all applicable users have had successful messages dropped in the notification reminder topic
                                    if (successfulUserMessagesSent === usersWithNoCards.data.length) {
                                        console.log(`__________________________________________________________________________________________________________________________________`);
                                        console.log(`Notification reminder successfully sent for users:\n${JSON.stringify(usersWithNoCards.data)}`);
                                        /**
                                         * 4) Once all users have been notified, then update the card linking reminder accordingly,
                                         * by calling the updateNotificationReminder AppSync Mutation API.
                                         */
                                        const updateNotificationReminderResponse = await moonbeamClient.updateNotificationReminder({
                                            id: reminder.id,
                                            notificationReminderStatus: moonbeam_models_1.NotificationReminderStatus.Active
                                        });
                                        // check if the update notification reminder call was successful or not.
                                        if (updateNotificationReminderResponse !== null && updateNotificationReminderResponse !== undefined &&
                                            !updateNotificationReminderResponse.errorMessage && !updateNotificationReminderResponse.errorType &&
                                            updateNotificationReminderResponse.data !== undefined && updateNotificationReminderResponse.data !== null &&
                                            updateNotificationReminderResponse.data.length !== 0) {
                                            console.log(`Notification reminder ${reminder.id} successfully updated`);
                                        }
                                        else {
                                            /**
                                             * no need for further actions, since this error will be logged and nothing will execute further.
                                             * in the future we might need some alerts and metrics emitting here
                                             */
                                            console.log(`Update notification reminder through UPDATE notification reminder call failed`);
                                        }
                                    }
                                    else {
                                        /**
                                         * no need for further actions, since this error will be logged and nothing will execute further.
                                         * in the future we might need some alerts and metrics emitting here
                                         */
                                        console.log(`Not all applicable users have had notification events dropped in the appropriate topic. Re-process these failed messages accordingly.`);
                                    }
                                }
                                else {
                                    /**
                                     * no need for further actions, since this error will be logged and nothing will execute further.
                                     * in the future we might need some alerts and metrics emitting here
                                     */
                                    console.log(`Users with no cards retrieval through GET users with no cards call failed`);
                                }
                                break;
                            default:
                                console.log(`Unknown notification reminder type passed in for ACTIVE reminder ${reminder.notificationReminderType}`);
                        }
                        activeReminderCount += 1;
                    }
                }
            }
            console.log(`__________________________________________________________________________________________________________________________________`);
            console.log(`Ran trigger for Notification Reminders at ${new Date(Date.now()).toISOString()}, and found ${activeReminderCount} ACTIVE reminders`);
        }
        else {
            /**
             * no need for further actions, since this error will be logged and nothing will execute further.
             * in the future we might need some alerts and metrics emitting here
             */
            console.log(`Notification Reminder retrieval through GET notification reminders call failed`);
        }
    }
    catch (error) {
        /**
         * no need for further actions, since this error will be logged and nothing will execute further.
         * in the future we might need some alerts and metrics emitting here
         */
        console.log(`Unexpected error while processing the notification reminder cron event ${error}`);
    }
};
exports.triggerNotificationReminder = triggerNotificationReminder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTm90aWZpY2F0aW9uUmVtaW5kZXJUcmlnZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xhbWJkYS9yZXNvbHZlcnMvTm90aWZpY2F0aW9uUmVtaW5kZXJUcmlnZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtEQU1tQztBQUNuQyxvREFBOEQ7QUFFOUQ7Ozs7R0FJRztBQUNJLE1BQU0sMkJBQTJCLEdBQUcsS0FBSyxJQUFtQixFQUFFO0lBQ2pFLElBQUk7UUFDQSx5Q0FBeUM7UUFDekMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFXLENBQUM7UUFFdkM7Ozs7Ozs7Ozs7Ozs7Ozs7O1dBaUJHO1FBQ0gsTUFBTSxjQUFjLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXpFLDRFQUE0RTtRQUM1RSxNQUFNLHFCQUFxQixHQUFpQyxNQUFNLGNBQWMsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1FBRTVHLDZFQUE2RTtRQUM3RSxJQUFJLHFCQUFxQixLQUFLLElBQUksSUFBSSxxQkFBcUIsS0FBSyxTQUFTLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxZQUFZO1lBQzVHLENBQUMscUJBQXFCLENBQUMsU0FBUyxJQUFJLHFCQUFxQixDQUFDLElBQUksS0FBSyxJQUFJLElBQUkscUJBQXFCLENBQUMsSUFBSSxLQUFLLFNBQVM7WUFDbkgscUJBQXFCLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDekMsbURBQW1EO1lBQ25ELElBQUksbUJBQW1CLEdBQUcsQ0FBQyxDQUFDO1lBQzVCLEtBQUssTUFBTSxRQUFRLElBQUkscUJBQXFCLENBQUMsSUFBSSxFQUFFO2dCQUMvQyxJQUFJLFFBQVMsQ0FBQywwQkFBMEIsSUFBSSw0Q0FBMEIsQ0FBQyxNQUFNLEVBQUU7b0JBQzNFLG9EQUFvRDtvQkFDcEQs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LENBQUMsdUlBQXVJLENBQUMsQ0FBQztxQ0FDeEo7aUNBQ0o7cUNBQU07b0NBQ0g7Ozt1Q0FHRztvQ0FDSCxPQUFPLENBQUMsR0FBRyxDQUFDLDJFQUEyRSxDQUFDLENBQUM7aUNBQzVGO2dDQUNELE1BQU07NEJBQ1Y7Z0NBQ0ksT0FBTyxDQUFDLEdBQUcsQ0FBQyxvRUFBb0UsUUFBUyxDQUFDLHdCQUF3QixFQUFFLENBQUMsQ0FBQzt5QkFDN0g7d0JBQ0QsbUJBQW1CLElBQUksQ0FBQyxDQUFDO3FCQUM1QjtpQkFDSjthQUNKO1lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvSUFBb0ksQ0FBQyxDQUFDO1lBQ2xKLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkNBQTZDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxlQUFlLG1CQUFtQixtQkFBbUIsQ0FBQyxDQUFDO1NBQ3JKO2FBQU07WUFDSDs7O2VBR0c7WUFDSCxPQUFPLENBQUMsR0FBRyxDQUFDLGdGQUFnRixDQUFDLENBQUM7U0FDakc7S0FDSjtJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ1o7OztXQUdHO1FBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQywwRUFBMEUsS0FBSyxFQUFFLENBQUMsQ0FBQztLQUNsRztBQUNMLENBQUMsQ0FBQTtBQS9KWSxRQUFBLDJCQUEyQiwrQkErSnZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBJbmVsaWdpYmxlTGlua2VkVXNlcnNSZXNwb25zZSxcbiAgICBNb29uYmVhbUNsaWVudCxcbiAgICBOb3RpZmljYXRpb25SZW1pbmRlclJlc3BvbnNlLFxuICAgIE5vdGlmaWNhdGlvblJlbWluZGVyU3RhdHVzLFxuICAgIE5vdGlmaWNhdGlvblJlbWluZGVyVHlwZSwgTm90aWZpY2F0aW9uVHlwZSwgVXNlckRldGFpbHNGb3JOb3RpZmljYXRpb25zXG59IGZyb20gXCJAbW9vbmJlYW0vbW9vbmJlYW0tbW9kZWxzXCI7XG5pbXBvcnQge1B1Ymxpc2hDb21tYW5kLCBTTlNDbGllbnR9IGZyb20gXCJAYXdzLXNkay9jbGllbnQtc25zXCI7XG5cbi8qKlxuICogRnVuY3Rpb24gdXNlZCB0byBoYW5kbGUgdGhlIGRhaWx5IG5vdGlmaWNhdGlvbiByZW1pbmRlciB0cmlnZ2VyLCBieSBmaXJzdFxuICogZGV0ZXJtaW5pbmcgd2hldGhlciBhIG5vdGlmaWNhdGlvbiByZW1pbmRlciBuZWVkcyB0byBiZSBzZW50IG91dCwgYW5kIGJ5XG4gKiBraWNrLXN0YXJ0aW5nIHRoYXQgcHJvY2VzcyBmb3IgYW55IGFwcGxpY2FibGUgdXNlcnMsIGFjY29yZGluZ2x5LlxuICovXG5leHBvcnQgY29uc3QgdHJpZ2dlck5vdGlmaWNhdGlvblJlbWluZGVyID0gYXN5bmMgKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIC8vIHJldHJpZXZpbmcgdGhlIGN1cnJlbnQgZnVuY3Rpb24gcmVnaW9uXG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT04hO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUaGUgb3ZlcmFsbCBub3RpZmljYXRpb24gcmVtaW5kZXIgY3JvbiB0cmlnZ2VyaW5nLCB3aWxsIGJlIG1hZGUgdXAgb2YgdGhlIGZvbGxvd2luZyBzdGVwczpcbiAgICAgICAgICpcbiAgICAgICAgICogMSkgQ2FsbCB0aGUgZ2V0Tm90aWZpY2F0aW9uUmVtaW5kZXJzIEFwcFN5bmMgUXVlcnkgQVBJIGluIG9yZGVyIHRvOlxuICAgICAgICAgKiAgICAtIGdldCBhbnkgQUNUSVZFIFJFTUlOREVSU1xuICAgICAgICAgKiAgICAtIGZvciBhbnkgQUNUSVZFIHJlbWluZGVycywgc29ydCB0aHJvdWdoIHRoZSBvbmVzIHRoYXQgbmVlZCB0byBnZXQgdHJpZ2dlcmVkXG4gICAgICAgICAqXG4gICAgICAgICAqIDIpIEZvciB0aGUgcmVtaW5kZXJzIHRoYXQgYXJlIG9mOlxuICAgICAgICAgKiAgICAtIENBUkRfTElOS0lOR19SRU1JTkRFUiB0eXBlLCBjYWxsIHRoZSBnZXRVc2Vyc1dpdGhOb0NhcmRzXG4gICAgICAgICAqICAgIEFwcFN5bmMgUXVlcnkgQVBJLCBpbiBvcmRlciB0byBnZXQgYWxsIHVzZXJzIHRvIHNlbmQgbm90aWZpY2F0aW9uIHJlbWluZGVycyB0by5cbiAgICAgICAgICogICAgLSBmb3IgYW55IG90aGVyIHR5cGVzLCB0aGlzIGlzIFRCRC5cbiAgICAgICAgICpcbiAgICAgICAgICogMykgRm9yIGVhY2ggYXBwbGljYWJsZSB1c2VyIGZyb20gc3RlcCAyKSBkcm9wIGEgbWVzc2FnZSBpbnRvIHRoZSBhcHByb3ByaWF0ZSBTTlMgdG9waWMuXG4gICAgICAgICAqXG4gICAgICAgICAqIDQpIE9uY2UgYWxsIHVzZXJzIGhhdmUgYmVlbiBub3RpZmllZCwgdGhlbiB1cGRhdGUgdGhlIGNhcmQgbGlua2luZyByZW1pbmRlciBhY2NvcmRpbmdseSxcbiAgICAgICAgICogYnkgY2FsbGluZyB0aGUgdXBkYXRlTm90aWZpY2F0aW9uUmVtaW5kZXIgQXBwU3luYyBNdXRhdGlvbiBBUEkuXG4gICAgICAgICAqXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBtb29uYmVhbUNsaWVudCA9IG5ldyBNb29uYmVhbUNsaWVudChwcm9jZXNzLmVudi5FTlZfTkFNRSEsIHJlZ2lvbik7XG5cbiAgICAgICAgLy8gMSkgQ2FsbCB0aGUgZ2V0Tm90aWZpY2F0aW9uUmVtaW5kZXJzIE1vb25iZWFtIEFwcFN5bmMgUXVlcnkgQVBJIGVuZHBvaW50LlxuICAgICAgICBjb25zdCBub3RpZmljYXRpb25SZW1pbmRlcnM6IE5vdGlmaWNhdGlvblJlbWluZGVyUmVzcG9uc2UgPSBhd2FpdCBtb29uYmVhbUNsaWVudC5nZXROb3RpZmljYXRpb25SZW1pbmRlcnMoKTtcblxuICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgdGhlIGdldCBub3RpZmljYXRpb24gcmVtaW5kZXJzIGNhbGwgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90LlxuICAgICAgICBpZiAobm90aWZpY2F0aW9uUmVtaW5kZXJzICE9PSBudWxsICYmIG5vdGlmaWNhdGlvblJlbWluZGVycyAhPT0gdW5kZWZpbmVkICYmICFub3RpZmljYXRpb25SZW1pbmRlcnMuZXJyb3JNZXNzYWdlICYmXG4gICAgICAgICAgICAhbm90aWZpY2F0aW9uUmVtaW5kZXJzLmVycm9yVHlwZSAmJiBub3RpZmljYXRpb25SZW1pbmRlcnMuZGF0YSAhPT0gbnVsbCAmJiBub3RpZmljYXRpb25SZW1pbmRlcnMuZGF0YSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICBub3RpZmljYXRpb25SZW1pbmRlcnMuZGF0YS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgIC8vIGZpbHRlciB0aHJvdWdoIGVhY2ggQUNUSVZFIG5vdGlmaWNhdGlvbiByZW1pbmRlclxuICAgICAgICAgICAgbGV0IGFjdGl2ZVJlbWluZGVyQ291bnQgPSAwO1xuICAgICAgICAgICAgZm9yIChjb25zdCByZW1pbmRlciBvZiBub3RpZmljYXRpb25SZW1pbmRlcnMuZGF0YSkge1xuICAgICAgICAgICAgICAgIGlmIChyZW1pbmRlciEubm90aWZpY2F0aW9uUmVtaW5kZXJTdGF0dXMgPT0gTm90aWZpY2F0aW9uUmVtaW5kZXJTdGF0dXMuQWN0aXZlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vICBzb3J0IHRocm91Z2ggdGhlIG9uZXMgdGhhdCBuZWVkIHRvIGdldCB0cmlnZ2VyZWRcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dFRyaWdnZXJEYXRlOiBEYXRlID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZW1pbmRlciEubmV4dFRyaWdnZXJBdCkpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50RGF0ZTogRGF0ZSA9IG5ldyBEYXRlKERhdGUubm93KCkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV4dFRyaWdnZXJEYXRlLmdldERhdGUoKSA9PT0gY3VycmVudERhdGUuZ2V0RGF0ZSgpICYmIG5leHRUcmlnZ2VyRGF0ZS5nZXRNb250aCgpID09PSBjdXJyZW50RGF0ZS5nZXRNb250aCgpICYmXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0VHJpZ2dlckRhdGUuZ2V0RnVsbFllYXIoKSA9PT0gY3VycmVudERhdGUuZ2V0RnVsbFllYXIoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChyZW1pbmRlciEubm90aWZpY2F0aW9uUmVtaW5kZXJUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBOb3RpZmljYXRpb25SZW1pbmRlclR5cGUuQ2FyZExpbmtpbmdSZW1pbmRlcjpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYF9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYEZvdW5kIG5ldyBBQ1RJVkUgbm90aWZpY2F0aW9uIHJlbWluZGVyICR7cmVtaW5kZXIhLmlkfSBvZiB0eXBlICR7Tm90aWZpY2F0aW9uUmVtaW5kZXJUeXBlLkNhcmRMaW5raW5nUmVtaW5kZXJ9YCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gMikgRm9yIGFueSBBQ1RJVkUgcmVtaW5kZXJzIG9mIHR5cGUgQ0FSRF9MSU5LSU5HX1JFTUlOREVSLCBjYWxsIHRoZSBnZXRVc2Vyc1dpdGhOb0NhcmRzIE1vb25iZWFtIEFwcFN5bmMgUXVlcnkgQVBJIGVuZHBvaW50LlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2Vyc1dpdGhOb0NhcmRzOiBJbmVsaWdpYmxlTGlua2VkVXNlcnNSZXNwb25zZSA9IGF3YWl0IG1vb25iZWFtQ2xpZW50LmdldFVzZXJzV2l0aE5vQ2FyZHMoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiB0aGUgZ2V0IHVzZXJzIHdpdGggbm8gY2FyZCBjYWxsIHdhcyBzdWNjZXNzZnVsIG9yIG5vdC5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVzZXJzV2l0aE5vQ2FyZHMgIT09IG51bGwgJiYgdXNlcnNXaXRoTm9DYXJkcyAhPT0gdW5kZWZpbmVkICYmICF1c2Vyc1dpdGhOb0NhcmRzLmVycm9yTWVzc2FnZSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIXVzZXJzV2l0aE5vQ2FyZHMuZXJyb3JUeXBlICYmIHVzZXJzV2l0aE5vQ2FyZHMuZGF0YSAhPT0gbnVsbCAmJiB1c2Vyc1dpdGhOb0NhcmRzLmRhdGEgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcnNXaXRoTm9DYXJkcy5kYXRhLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gMykgRm9yIGVhY2ggYXBwbGljYWJsZSB1c2VyIGZyb20gc3RlcCAyKSBkcm9wIGEgbWVzc2FnZSBpbnRvIHRoZSBhcHByb3ByaWF0ZSBTTlMgdG9waWMuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3VjY2Vzc2Z1bFVzZXJNZXNzYWdlc1NlbnQgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBpbmVsaWdpYmxlVXNlciBvZiB1c2Vyc1dpdGhOb0NhcmRzLmRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpbml0aWFsaXppbmcgdGhlIFNOUyBDbGllbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzbnNDbGllbnQgPSBuZXcgU05TQ2xpZW50KHtyZWdpb246IHJlZ2lvbn0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogZHJvcCB0aGUgaW5lbGlnaWJsZSB1c2VyIGlucHV0IGFzIGEgbWVzc2FnZSB0byB0aGUgbm90aWZpY2F0aW9uIHJlbWluZGVyIHByb2Nlc3NpbmcgdG9waWNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyRGV0YWlsc0Zvck5vdGlmaWNhdGlvbnM6IFVzZXJEZXRhaWxzRm9yTm90aWZpY2F0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGluZWxpZ2libGVVc2VyIS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1haWw6IGluZWxpZ2libGVVc2VyIS5lbWFpbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3ROYW1lOiBpbmVsaWdpYmxlVXNlciEuZmlyc3ROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0TmFtZTogaW5lbGlnaWJsZVVzZXIhLmxhc3ROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25DaGFubmVsVHlwZTogcmVtaW5kZXIhLm5vdGlmaWNhdGlvbkNoYW5uZWxUeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25UeXBlOiBOb3RpZmljYXRpb25UeXBlLkNhcmRMaW5raW5nUmVtaW5kZXJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uUmVtaW5kZXJSZWNlaXB0ID0gYXdhaXQgc25zQ2xpZW50LnNlbmQobmV3IFB1Ymxpc2hDb21tYW5kKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVG9waWNBcm46IHByb2Nlc3MuZW52Lk5PVElGSUNBVElPTl9SRU1JTkRFUl9QUk9DRVNTSU5HX1RPUElDX0FSTiEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KHVzZXJEZXRhaWxzRm9yTm90aWZpY2F0aW9ucyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiB0aGUgbWVzc2FnZSBncm91cCBpZCwgd2lsbCBiZSByZXByZXNlbnRlZCBieSB0aGUgTW9vbmJlYW0gaW50ZXJuYWwgdXNlciBpZCwgc28gdGhhdCB3ZSBjYW4gZ3JvdXAgdGhlIG5vdGlmaWNhdGlvbiByZW1pbmRlciB1cGRhdGUgbWVzc2FnZXMgZm9yIGEgcGFydGljdWxhclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiB1c2VyIGlkLCBhbmQgc29ydCB0aGVtIGluIHRoZSBGSUZPIHByb2Nlc3NpbmcgdG9waWMgYWNjb3JkaW5nbHkuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNZXNzYWdlR3JvdXBJZDogaW5lbGlnaWJsZVVzZXIhLmlkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW5zdXJlIHRoYXQgdGhlIG5vdGlmaWNhdGlvbiByZW1pbmRlciBtZXNzYWdlIHdhcyBwcm9wZXJseSBzZW50IHRvIHRoZSBhcHByb3ByaWF0ZSBwcm9jZXNzaW5nIHRvcGljXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGlmaWNhdGlvblJlbWluZGVyUmVjZWlwdCAhPT0gbnVsbCAmJiBub3RpZmljYXRpb25SZW1pbmRlclJlY2VpcHQgIT09IHVuZGVmaW5lZCAmJiBub3RpZmljYXRpb25SZW1pbmRlclJlY2VpcHQuTWVzc2FnZUlkICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvblJlbWluZGVyUmVjZWlwdC5NZXNzYWdlSWQubGVuZ3RoICE9PSAwICYmIG5vdGlmaWNhdGlvblJlbWluZGVyUmVjZWlwdC5TZXF1ZW5jZU51bWJlciAmJiBub3RpZmljYXRpb25SZW1pbmRlclJlY2VpcHQuU2VxdWVuY2VOdW1iZXIubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBub3RpZmljYXRpb24gcmVtaW5kZXIgbWVzc2FnZSBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgZHJvcHBlZCBpbnRvIHRoZSB0b3BpYywgYW5kIHdpbGwgYmUgcGlja2VkIHVwIGJ5IHRoZSBub3RpZmljYXRpb24gcmVtaW5kZXIgY29uc3VtZXJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYE5vdGlmaWNhdGlvbiByZW1pbmRlciBzdWNjZXNzZnVsbHkgc2VudCB0byB0b3BpYyBmb3IgcHJvY2Vzc2luZyB3aXRoIHJlY2VpcHQgaW5mb3JtYXRpb246ICR7bm90aWZpY2F0aW9uUmVtaW5kZXJSZWNlaXB0Lk1lc3NhZ2VJZH0gJHtub3RpZmljYXRpb25SZW1pbmRlclJlY2VpcHQuU2VxdWVuY2VOdW1iZXJ9YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluY3JlYXNlIHRoZSBudW1iZXIgb2YgbWVzc2FnZXMgc2VudCB0byB0aGUgdG9waWNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc2Z1bFVzZXJNZXNzYWdlc1NlbnQgKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogbm8gbmVlZCBmb3IgZnVydGhlciBhY3Rpb25zLCBzaW5jZSB0aGlzIGVycm9yIHdpbGwgYmUgbG9nZ2VkIGFuZCBub3RoaW5nIHdpbGwgZXhlY3V0ZSBmdXJ0aGVyLlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiBpbiB0aGUgZnV0dXJlIHdlIG1pZ2h0IG5lZWQgc29tZSBhbGVydHMgYW5kIG1ldHJpY3MgZW1pdHRpbmcgaGVyZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFVuZXhwZWN0ZWQgZXJyb3Igd2hpbGUgc2VuZGluZyB0aGUgbm90aWZpY2F0aW9uIHJlbWluZGVyIGZvciB1c2VyICR7aW5lbGlnaWJsZVVzZXIhLmlkfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGFsbCBhcHBsaWNhYmxlIHVzZXJzIGhhdmUgaGFkIHN1Y2Nlc3NmdWwgbWVzc2FnZXMgZHJvcHBlZCBpbiB0aGUgbm90aWZpY2F0aW9uIHJlbWluZGVyIHRvcGljXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VjY2Vzc2Z1bFVzZXJNZXNzYWdlc1NlbnQgPT09IHVzZXJzV2l0aE5vQ2FyZHMuZGF0YS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX2ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBOb3RpZmljYXRpb24gcmVtaW5kZXIgc3VjY2Vzc2Z1bGx5IHNlbnQgZm9yIHVzZXJzOlxcbiR7SlNPTi5zdHJpbmdpZnkodXNlcnNXaXRoTm9DYXJkcy5kYXRhKX1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiA0KSBPbmNlIGFsbCB1c2VycyBoYXZlIGJlZW4gbm90aWZpZWQsIHRoZW4gdXBkYXRlIHRoZSBjYXJkIGxpbmtpbmcgcmVtaW5kZXIgYWNjb3JkaW5nbHksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogYnkgY2FsbGluZyB0aGUgdXBkYXRlTm90aWZpY2F0aW9uUmVtaW5kZXIgQXBwU3luYyBNdXRhdGlvbiBBUEkuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlTm90aWZpY2F0aW9uUmVtaW5kZXJSZXNwb25zZTogTm90aWZpY2F0aW9uUmVtaW5kZXJSZXNwb25zZSA9IGF3YWl0IG1vb25iZWFtQ2xpZW50LnVwZGF0ZU5vdGlmaWNhdGlvblJlbWluZGVyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IHJlbWluZGVyIS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uUmVtaW5kZXJTdGF0dXM6IE5vdGlmaWNhdGlvblJlbWluZGVyU3RhdHVzLkFjdGl2ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgdGhlIHVwZGF0ZSBub3RpZmljYXRpb24gcmVtaW5kZXIgY2FsbCB3YXMgc3VjY2Vzc2Z1bCBvciBub3QuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZU5vdGlmaWNhdGlvblJlbWluZGVyUmVzcG9uc2UgIT09IG51bGwgJiYgdXBkYXRlTm90aWZpY2F0aW9uUmVtaW5kZXJSZXNwb25zZSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICF1cGRhdGVOb3RpZmljYXRpb25SZW1pbmRlclJlc3BvbnNlLmVycm9yTWVzc2FnZSAmJiAhdXBkYXRlTm90aWZpY2F0aW9uUmVtaW5kZXJSZXNwb25zZS5lcnJvclR5cGUgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlTm90aWZpY2F0aW9uUmVtaW5kZXJSZXNwb25zZS5kYXRhICE9PSB1bmRlZmluZWQgJiYgdXBkYXRlTm90aWZpY2F0aW9uUmVtaW5kZXJSZXNwb25zZS5kYXRhICE9PSBudWxsICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZU5vdGlmaWNhdGlvblJlbWluZGVyUmVzcG9uc2UuZGF0YS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYE5vdGlmaWNhdGlvbiByZW1pbmRlciAke3JlbWluZGVyIS5pZH0gc3VjY2Vzc2Z1bGx5IHVwZGF0ZWRgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogbm8gbmVlZCBmb3IgZnVydGhlciBhY3Rpb25zLCBzaW5jZSB0aGlzIGVycm9yIHdpbGwgYmUgbG9nZ2VkIGFuZCBub3RoaW5nIHdpbGwgZXhlY3V0ZSBmdXJ0aGVyLlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiBpbiB0aGUgZnV0dXJlIHdlIG1pZ2h0IG5lZWQgc29tZSBhbGVydHMgYW5kIG1ldHJpY3MgZW1pdHRpbmcgaGVyZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFVwZGF0ZSBub3RpZmljYXRpb24gcmVtaW5kZXIgdGhyb3VnaCBVUERBVEUgbm90aWZpY2F0aW9uIHJlbWluZGVyIGNhbGwgZmFpbGVkYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiBubyBuZWVkIGZvciBmdXJ0aGVyIGFjdGlvbnMsIHNpbmNlIHRoaXMgZXJyb3Igd2lsbCBiZSBsb2dnZWQgYW5kIG5vdGhpbmcgd2lsbCBleGVjdXRlIGZ1cnRoZXIuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogaW4gdGhlIGZ1dHVyZSB3ZSBtaWdodCBuZWVkIHNvbWUgYWxlcnRzIGFuZCBtZXRyaWNzIGVtaXR0aW5nIGhlcmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTm90IGFsbCBhcHBsaWNhYmxlIHVzZXJzIGhhdmUgaGFkIG5vdGlmaWNhdGlvbiBldmVudHMgZHJvcHBlZCBpbiB0aGUgYXBwcm9wcmlhdGUgdG9waWMuIFJlLXByb2Nlc3MgdGhlc2UgZmFpbGVkIG1lc3NhZ2VzIGFjY29yZGluZ2x5LmApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiBubyBuZWVkIGZvciBmdXJ0aGVyIGFjdGlvbnMsIHNpbmNlIHRoaXMgZXJyb3Igd2lsbCBiZSBsb2dnZWQgYW5kIG5vdGhpbmcgd2lsbCBleGVjdXRlIGZ1cnRoZXIuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKiBpbiB0aGUgZnV0dXJlIHdlIG1pZ2h0IG5lZWQgc29tZSBhbGVydHMgYW5kIG1ldHJpY3MgZW1pdHRpbmcgaGVyZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVXNlcnMgd2l0aCBubyBjYXJkcyByZXRyaWV2YWwgdGhyb3VnaCBHRVQgdXNlcnMgd2l0aCBubyBjYXJkcyBjYWxsIGZhaWxlZGApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBVbmtub3duIG5vdGlmaWNhdGlvbiByZW1pbmRlciB0eXBlIHBhc3NlZCBpbiBmb3IgQUNUSVZFIHJlbWluZGVyICR7cmVtaW5kZXIhLm5vdGlmaWNhdGlvblJlbWluZGVyVHlwZX1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVJlbWluZGVyQ291bnQgKz0gMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fYCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgUmFuIHRyaWdnZXIgZm9yIE5vdGlmaWNhdGlvbiBSZW1pbmRlcnMgYXQgJHtuZXcgRGF0ZShEYXRlLm5vdygpKS50b0lTT1N0cmluZygpfSwgYW5kIGZvdW5kICR7YWN0aXZlUmVtaW5kZXJDb3VudH0gQUNUSVZFIHJlbWluZGVyc2ApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBubyBuZWVkIGZvciBmdXJ0aGVyIGFjdGlvbnMsIHNpbmNlIHRoaXMgZXJyb3Igd2lsbCBiZSBsb2dnZWQgYW5kIG5vdGhpbmcgd2lsbCBleGVjdXRlIGZ1cnRoZXIuXG4gICAgICAgICAgICAgKiBpbiB0aGUgZnV0dXJlIHdlIG1pZ2h0IG5lZWQgc29tZSBhbGVydHMgYW5kIG1ldHJpY3MgZW1pdHRpbmcgaGVyZVxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgTm90aWZpY2F0aW9uIFJlbWluZGVyIHJldHJpZXZhbCB0aHJvdWdoIEdFVCBub3RpZmljYXRpb24gcmVtaW5kZXJzIGNhbGwgZmFpbGVkYCk7XG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvKipcbiAgICAgICAgICogbm8gbmVlZCBmb3IgZnVydGhlciBhY3Rpb25zLCBzaW5jZSB0aGlzIGVycm9yIHdpbGwgYmUgbG9nZ2VkIGFuZCBub3RoaW5nIHdpbGwgZXhlY3V0ZSBmdXJ0aGVyLlxuICAgICAgICAgKiBpbiB0aGUgZnV0dXJlIHdlIG1pZ2h0IG5lZWQgc29tZSBhbGVydHMgYW5kIG1ldHJpY3MgZW1pdHRpbmcgaGVyZVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc29sZS5sb2coYFVuZXhwZWN0ZWQgZXJyb3Igd2hpbGUgcHJvY2Vzc2luZyB0aGUgbm90aWZpY2F0aW9uIHJlbWluZGVyIGNyb24gZXZlbnQgJHtlcnJvcn1gKTtcbiAgICB9XG59XG4iXX0=