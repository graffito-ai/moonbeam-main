"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.processMilitaryVerificationUpdate = void 0;
const moonbeam_models_1 = require("@moonbeam/moonbeam-models");
/**
 * MilitaryVerificationUpdatesProcessorHandler handler
 *
 * @param event the {@link SQSEvent} to be processed, containing the military verification update
 * message information
 * @returns {@link Promise} of {@link SQSBatchResponse}
 */
const processMilitaryVerificationUpdate = async (event) => {
    try {
        // retrieving the current function region
        const region = process.env.AWS_REGION;
        /**
         * initializing the batch response, as an empty array, that will be populated with errors, if any throughout the processing
         *
         * for the Lambda to indicate SQS that there have been no failures, and thus enable the deletion of all processed messages
         * from the queue, we have to return an empty batchItemFailures array. If we want to indicate that there have been errors,
         * for each individual message, based on its ID, we have to add it in the final batch response
         *
         * @link https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html
         */
        const itemFailures = [];
        // for each record in the incoming event, repeat the military verification update/notification steps
        for (const militaryVerificationUpdateRecord of event.Records) {
            // first, convert the incoming event message body, into a MilitaryVerificationNotificationUpdate object
            const militaryVerificationNotificationUpdate = JSON.parse(militaryVerificationUpdateRecord.body);
            /**
             * The overall military verification update/notification event processing, will be made up of the following steps:
             *
             * 1) Call the getDevicesForUser Moonbeam AppSync API endpoint, to retrieve all physical devices associated with an
             * incoming user.
             * 2) Filter obtained devices based on their status (only consider the ones that are ACTIVE for the user).
             * 3) Retrieve the email of a user based on their id
             * 4) Call the createNotification Moonbeam AppSync API endpoint, to store the military verification update transaction in Dynamo DB
             * and send the appropriate notification through Courier accordingly (email + push notification).
             */
            // initialize the Moonbeam Client API here, in order to call the appropriate endpoints for this handler
            const moonbeamClient = new moonbeam_models_1.MoonbeamClient(process.env.ENV_NAME, region);
            // 1) Call the getDevicesForUser Moonbeam Appsync API endpoint.
            const devicesForUserResponse = await moonbeamClient.getDevicesForUser({
                id: militaryVerificationNotificationUpdate.id
            });
            /**
             * check to see if the get devices for user call was successful or not.
             *
             * we also consider the failure message, for users with no physical devices. In that case we only send an
             * email.
             */
            if ((devicesForUserResponse && !devicesForUserResponse.errorMessage && !devicesForUserResponse.errorType &&
                devicesForUserResponse.data && devicesForUserResponse.data.length !== 0) ||
                (devicesForUserResponse && devicesForUserResponse.errorType !== null && devicesForUserResponse.errorType !== undefined &&
                    devicesForUserResponse.errorType === moonbeam_models_1.UserDeviceErrorType.NoneOrAbsent)) {
                const deviceTokenIds = [];
                if (devicesForUserResponse && devicesForUserResponse.errorType !== null && devicesForUserResponse.errorType !== undefined &&
                    devicesForUserResponse.errorType === moonbeam_models_1.UserDeviceErrorType.NoneOrAbsent) {
                    console.log(`No physical devices found for user ${militaryVerificationNotificationUpdate.id}`);
                }
                else {
                    if (devicesForUserResponse.data !== null && devicesForUserResponse.data !== undefined) {
                        // 2) Filter obtained devices based on their status (only consider the ones that are ACTIVE for the user).
                        for (const userDevice of devicesForUserResponse.data) {
                            userDevice.deviceState === moonbeam_models_1.UserDeviceState.Active && deviceTokenIds.push(userDevice.tokenId);
                        }
                    }
                }
                // 3) Retrieve the email of a user based on their information (name, address, and birthday)
                const emailFromUserInformationResponse = await moonbeamClient.getEmailForUser(militaryVerificationNotificationUpdate);
                // check to see if the get email for user call was successful or not
                if (emailFromUserInformationResponse && !emailFromUserInformationResponse.errorMessage && !emailFromUserInformationResponse.errorType &&
                    emailFromUserInformationResponse.data && emailFromUserInformationResponse.data.length !== 0) {
                    // determine what type of notification we have, depending on the military verification status that we're transitioning to
                    const notificationType = (militaryVerificationNotificationUpdate.originalMilitaryVerificationStatus === moonbeam_models_1.MilitaryVerificationStatusType.Pending &&
                        militaryVerificationNotificationUpdate.newMilitaryVerificationStatus === moonbeam_models_1.MilitaryVerificationStatusType.Verified) ? moonbeam_models_1.NotificationType.MilitaryStatusChangedPendingToVerified :
                        (militaryVerificationNotificationUpdate.originalMilitaryVerificationStatus === moonbeam_models_1.MilitaryVerificationStatusType.Pending &&
                            militaryVerificationNotificationUpdate.newMilitaryVerificationStatus === moonbeam_models_1.MilitaryVerificationStatusType.Rejected) ? moonbeam_models_1.NotificationType.MilitaryStatusChangedPendingToRejected : null;
                    if (notificationType !== null) {
                        // 4) Call the createNotification Moonbeam AppSync API endpoint to create an email notification for the military status update
                        const createEmailNotificationResponse = await moonbeamClient.createNotification({
                            id: militaryVerificationNotificationUpdate.id,
                            type: notificationType,
                            channelType: moonbeam_models_1.NotificationChannelType.Email,
                            userFullName: `${militaryVerificationNotificationUpdate.firstName} ${militaryVerificationNotificationUpdate.lastName}`,
                            emailDestination: emailFromUserInformationResponse.data,
                            status: moonbeam_models_1.NotificationStatus.Sent
                        });
                        // check to see if the email notification call was successful or not
                        if (createEmailNotificationResponse && !createEmailNotificationResponse.errorMessage && !createEmailNotificationResponse.errorType && createEmailNotificationResponse.data) {
                            console.log(`Notification email event successfully processed, with notification id ${createEmailNotificationResponse.data.notificationId}`);
                            // if there are user associated physical devices that are active, to send notifications to, then proceed accordingly
                            if (deviceTokenIds.length !== 0) {
                                // 4) Call the createNotification Moonbeam AppSync API endpoint to create a push notification for the military status update
                                const createPushNotificationResponse = await moonbeamClient.createNotification({
                                    id: militaryVerificationNotificationUpdate.id,
                                    type: notificationType,
                                    expoPushTokens: deviceTokenIds,
                                    channelType: moonbeam_models_1.NotificationChannelType.Push,
                                    status: moonbeam_models_1.NotificationStatus.Sent
                                });
                                // check to see if the email notification call was successful or not
                                if (createPushNotificationResponse && !createPushNotificationResponse.errorMessage && !createPushNotificationResponse.errorType && createPushNotificationResponse.data) {
                                    console.log(`Notification push event successfully processed, with notification id ${createPushNotificationResponse.data.notificationId}`);
                                }
                                else {
                                    console.log(`Notification push event through Create Notification call failed`);
                                    // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                                    itemFailures.push({
                                        itemIdentifier: militaryVerificationUpdateRecord.messageId
                                    });
                                }
                            }
                        }
                        else {
                            console.log(`Notification email event through Create Notification call failed`);
                            // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                            itemFailures.push({
                                itemIdentifier: militaryVerificationUpdateRecord.messageId
                            });
                        }
                    }
                    else {
                        console.log(`Invalid notification verification status transition - ${militaryVerificationNotificationUpdate.originalMilitaryVerificationStatus} to
                        ${militaryVerificationNotificationUpdate.newMilitaryVerificationStatus}!`);
                        // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                        itemFailures.push({
                            itemIdentifier: militaryVerificationUpdateRecord.messageId
                        });
                    }
                }
                else {
                    console.log(`User email mapping through GET email for user call failed`);
                    // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                    itemFailures.push({
                        itemIdentifier: militaryVerificationUpdateRecord.messageId
                    });
                }
            }
            else {
                console.log(`Physical Devices mapping through GET devices for user call failed`);
                // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                itemFailures.push({
                    itemIdentifier: militaryVerificationUpdateRecord.messageId
                });
            }
        }
        /**
         * for the Lambda to indicate SQS that there have been no failures, and thus enable the deletion of all processed messages
         * from the queue, we have to return an empty batchItemFailures array here.
         *
         * @link https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html
         */
        return {
            batchItemFailures: itemFailures
        };
    }
    catch (error) {
        console.log(`Unexpected error while processing ${JSON.stringify(event)} military verification update event ${error}`);
        /**
         * returns a batch response failure for the particular message IDs which failed
         * in this case, the Lambda function DOES NOT delete the incoming messages from the queue, and it makes it available/visible again
         *
         * @link https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html
         */
        return {
            batchItemFailures: [{
                    // for this case, we only process 1 record at a time, we might need to change this in the future
                    itemIdentifier: event.Records[0].messageId
                }]
        };
    }
};
exports.processMilitaryVerificationUpdate = processMilitaryVerificationUpdate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWlsaXRhcnlWZXJpZmljYXRpb25VcGRhdGVzUHJvY2Vzc29ySGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW1iZGEvaGFuZGxlcnMvTWlsaXRhcnlWZXJpZmljYXRpb25VcGRhdGVzUHJvY2Vzc29ySGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSwrREFZbUM7QUFFbkM7Ozs7OztHQU1HO0FBQ0ksTUFBTSxpQ0FBaUMsR0FBRyxLQUFLLEVBQUUsS0FBZSxFQUE2QixFQUFFO0lBQ2xHLElBQUk7UUFDQSx5Q0FBeUM7UUFDekMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFXLENBQUM7UUFFdkM7Ozs7Ozs7O1dBUUc7UUFDSCxNQUFNLFlBQVksR0FBMEIsRUFBRSxDQUFDO1FBRS9DLG9HQUFvRztRQUNwRyxLQUFLLE1BQU0sZ0NBQWdDLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUMxRCx1R0FBdUc7WUFDdkcsTUFBTSxzQ0FBc0MsR0FBMkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxJQUFJLENBQTJDLENBQUM7WUFFbkw7Ozs7Ozs7OztlQVNHO1lBQ0MsdUdBQXVHO1lBQzNHLE1BQU0sY0FBYyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUV6RSwrREFBK0Q7WUFDL0QsTUFBTSxzQkFBc0IsR0FBd0IsTUFBTSxjQUFjLENBQUMsaUJBQWlCLENBQUM7Z0JBQ3ZGLEVBQUUsRUFBRSxzQ0FBc0MsQ0FBQyxFQUFFO2FBQ2hELENBQUMsQ0FBQztZQUVIOzs7OztlQUtHO1lBQ0gsSUFBSSxDQUFDLHNCQUFzQixJQUFJLENBQUMsc0JBQXNCLENBQUMsWUFBWSxJQUFJLENBQUMsc0JBQXNCLENBQUMsU0FBUztnQkFDcEcsc0JBQXNCLENBQUMsSUFBSSxJQUFJLHNCQUFzQixD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bkcsWUFBWSxDQUFDLElBQUksQ0FBQzs0QkFDZCxjQUFjLEVBQUUsZ0NBQWdDLENBQUMsU0FBUzt5QkFDN0QsQ0FBQyxDQUFDO3FCQUNOO2lCQUNKO3FCQUFNO29CQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsMkRBQTJELENBQUMsQ0FBQztvQkFFekUsbUdBQW1HO29CQUNuRyxZQUFZLENBQUMsSUFBSSxDQUFDO3dCQUNkLGNBQWMsRUFBRSxnQ0FBZ0MsQ0FBQyxTQUFTO3FCQUM3RCxDQUFDLENBQUM7aUJBQ047YUFDSjtpQkFBTTtnQkFDSCxPQUFPLENBQUMsR0FBRyxDQUFDLG1FQUFtRSxDQUFDLENBQUM7Z0JBRWpGLG1HQUFtRztnQkFDbkcsWUFBWSxDQUFDLElBQUksQ0FBQztvQkFDZCxjQUFjLEVBQUUsZ0NBQWdDLENBQUMsU0FBUztpQkFDN0QsQ0FBQyxDQUFDO2FBQ047U0FDSjtRQUVEOzs7OztXQUtHO1FBQ0gsT0FBTztZQUNILGlCQUFpQixFQUFFLFlBQVk7U0FDbEMsQ0FBQTtLQUNKO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDWixPQUFPLENBQUMsR0FBRyxDQUFDLHFDQUFxQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyx1Q0FBdUMsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUV0SDs7Ozs7V0FLRztRQUNILE9BQU87WUFDSCxpQkFBaUIsRUFBRSxDQUFDO29CQUNoQixnR0FBZ0c7b0JBQ2hHLGNBQWMsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVM7aUJBQzdDLENBQUM7U0FDTCxDQUFBO0tBQ0o7QUFDTCxDQUFDLENBQUE7QUFsTFksUUFBQSxpQ0FBaUMscUNBa0w3QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U1FTQmF0Y2hSZXNwb25zZSwgU1FTRXZlbnR9IGZyb20gXCJhd3MtbGFtYmRhXCI7XG5pbXBvcnQge1NRU0JhdGNoSXRlbUZhaWx1cmV9IGZyb20gXCJhd3MtbGFtYmRhL3RyaWdnZXIvc3FzXCI7XG5pbXBvcnQge1xuICAgIENyZWF0ZU5vdGlmaWNhdGlvblJlc3BvbnNlLFxuICAgIEVtYWlsRnJvbUNvZ25pdG9SZXNwb25zZSxcbiAgICBNaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZSxcbiAgICBNaWxpdGFyeVZlcmlmaWNhdGlvblN0YXR1c1R5cGUsXG4gICAgTW9vbmJlYW1DbGllbnQsXG4gICAgTm90aWZpY2F0aW9uQ2hhbm5lbFR5cGUsXG4gICAgTm90aWZpY2F0aW9uU3RhdHVzLFxuICAgIE5vdGlmaWNhdGlvblR5cGUsXG4gICAgVXNlckRldmljZUVycm9yVHlwZSxcbiAgICBVc2VyRGV2aWNlc1Jlc3BvbnNlLFxuICAgIFVzZXJEZXZpY2VTdGF0ZVxufSBmcm9tIFwiQG1vb25iZWFtL21vb25iZWFtLW1vZGVsc1wiO1xuXG4vKipcbiAqIE1pbGl0YXJ5VmVyaWZpY2F0aW9uVXBkYXRlc1Byb2Nlc3NvckhhbmRsZXIgaGFuZGxlclxuICpcbiAqIEBwYXJhbSBldmVudCB0aGUge0BsaW5rIFNRU0V2ZW50fSB0byBiZSBwcm9jZXNzZWQsIGNvbnRhaW5pbmcgdGhlIG1pbGl0YXJ5IHZlcmlmaWNhdGlvbiB1cGRhdGVcbiAqIG1lc3NhZ2UgaW5mb3JtYXRpb25cbiAqIEByZXR1cm5zIHtAbGluayBQcm9taXNlfSBvZiB7QGxpbmsgU1FTQmF0Y2hSZXNwb25zZX1cbiAqL1xuZXhwb3J0IGNvbnN0IHByb2Nlc3NNaWxpdGFyeVZlcmlmaWNhdGlvblVwZGF0ZSA9IGFzeW5jIChldmVudDogU1FTRXZlbnQpOiBQcm9taXNlPFNRU0JhdGNoUmVzcG9uc2U+ID0+IHtcbiAgICB0cnkge1xuICAgICAgICAvLyByZXRyaWV2aW5nIHRoZSBjdXJyZW50IGZ1bmN0aW9uIHJlZ2lvblxuICAgICAgICBjb25zdCByZWdpb24gPSBwcm9jZXNzLmVudi5BV1NfUkVHSU9OITtcblxuICAgICAgICAvKipcbiAgICAgICAgICogaW5pdGlhbGl6aW5nIHRoZSBiYXRjaCByZXNwb25zZSwgYXMgYW4gZW1wdHkgYXJyYXksIHRoYXQgd2lsbCBiZSBwb3B1bGF0ZWQgd2l0aCBlcnJvcnMsIGlmIGFueSB0aHJvdWdob3V0IHRoZSBwcm9jZXNzaW5nXG4gICAgICAgICAqXG4gICAgICAgICAqIGZvciB0aGUgTGFtYmRhIHRvIGluZGljYXRlIFNRUyB0aGF0IHRoZXJlIGhhdmUgYmVlbiBubyBmYWlsdXJlcywgYW5kIHRodXMgZW5hYmxlIHRoZSBkZWxldGlvbiBvZiBhbGwgcHJvY2Vzc2VkIG1lc3NhZ2VzXG4gICAgICAgICAqIGZyb20gdGhlIHF1ZXVlLCB3ZSBoYXZlIHRvIHJldHVybiBhbiBlbXB0eSBiYXRjaEl0ZW1GYWlsdXJlcyBhcnJheS4gSWYgd2Ugd2FudCB0byBpbmRpY2F0ZSB0aGF0IHRoZXJlIGhhdmUgYmVlbiBlcnJvcnMsXG4gICAgICAgICAqIGZvciBlYWNoIGluZGl2aWR1YWwgbWVzc2FnZSwgYmFzZWQgb24gaXRzIElELCB3ZSBoYXZlIHRvIGFkZCBpdCBpbiB0aGUgZmluYWwgYmF0Y2ggcmVzcG9uc2VcbiAgICAgICAgICpcbiAgICAgICAgICogQGxpbmsgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvd2l0aC1zcXMuaHRtbFxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3QgaXRlbUZhaWx1cmVzOiBTUVNCYXRjaEl0ZW1GYWlsdXJlW10gPSBbXTtcblxuICAgICAgICAvLyBmb3IgZWFjaCByZWNvcmQgaW4gdGhlIGluY29taW5nIGV2ZW50LCByZXBlYXQgdGhlIG1pbGl0YXJ5IHZlcmlmaWNhdGlvbiB1cGRhdGUvbm90aWZpY2F0aW9uIHN0ZXBzXG4gICAgICAgIGZvciAoY29uc3QgbWlsaXRhcnlWZXJpZmljYXRpb25VcGRhdGVSZWNvcmQgb2YgZXZlbnQuUmVjb3Jkcykge1xuICAgICAgICAgICAgLy8gZmlyc3QsIGNvbnZlcnQgdGhlIGluY29taW5nIGV2ZW50IG1lc3NhZ2UgYm9keSwgaW50byBhIE1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlIG9iamVjdFxuICAgICAgICAgICAgY29uc3QgbWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGU6IE1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlID0gSlNPTi5wYXJzZShtaWxpdGFyeVZlcmlmaWNhdGlvblVwZGF0ZVJlY29yZC5ib2R5KSBhcyBNaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZTtcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBUaGUgb3ZlcmFsbCBtaWxpdGFyeSB2ZXJpZmljYXRpb24gdXBkYXRlL25vdGlmaWNhdGlvbiBldmVudCBwcm9jZXNzaW5nLCB3aWxsIGJlIG1hZGUgdXAgb2YgdGhlIGZvbGxvd2luZyBzdGVwczpcbiAgICAgICAgICAgICAqXG4gICAgICAgICAgICAgKiAxKSBDYWxsIHRoZSBnZXREZXZpY2VzRm9yVXNlciBNb29uYmVhbSBBcHBTeW5jIEFQSSBlbmRwb2ludCwgdG8gcmV0cmlldmUgYWxsIHBoeXNpY2FsIGRldmljZXMgYXNzb2NpYXRlZCB3aXRoIGFuXG4gICAgICAgICAgICAgKiBpbmNvbWluZyB1c2VyLlxuICAgICAgICAgICAgICogMikgRmlsdGVyIG9idGFpbmVkIGRldmljZXMgYmFzZWQgb24gdGhlaXIgc3RhdHVzIChvbmx5IGNvbnNpZGVyIHRoZSBvbmVzIHRoYXQgYXJlIEFDVElWRSBmb3IgdGhlIHVzZXIpLlxuICAgICAgICAgICAgICogMykgUmV0cmlldmUgdGhlIGVtYWlsIG9mIGEgdXNlciBiYXNlZCBvbiB0aGVpciBpZFxuICAgICAgICAgICAgICogNCkgQ2FsbCB0aGUgY3JlYXRlTm90aWZpY2F0aW9uIE1vb25iZWFtIEFwcFN5bmMgQVBJIGVuZHBvaW50LCB0byBzdG9yZSB0aGUgbWlsaXRhcnkgdmVyaWZpY2F0aW9uIHVwZGF0ZSB0cmFuc2FjdGlvbiBpbiBEeW5hbW8gREJcbiAgICAgICAgICAgICAqIGFuZCBzZW5kIHRoZSBhcHByb3ByaWF0ZSBub3RpZmljYXRpb24gdGhyb3VnaCBDb3VyaWVyIGFjY29yZGluZ2x5IChlbWFpbCArIHB1c2ggbm90aWZpY2F0aW9uKS5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIC8vIGluaXRpYWxpemUgdGhlIE1vb25iZWFtIENsaWVudCBBUEkgaGVyZSwgaW4gb3JkZXIgdG8gY2FsbCB0aGUgYXBwcm9wcmlhdGUgZW5kcG9pbnRzIGZvciB0aGlzIGhhbmRsZXJcbiAgICAgICAgICAgIGNvbnN0IG1vb25iZWFtQ2xpZW50ID0gbmV3IE1vb25iZWFtQ2xpZW50KHByb2Nlc3MuZW52LkVOVl9OQU1FISwgcmVnaW9uKTtcblxuICAgICAgICAgICAgLy8gMSkgQ2FsbCB0aGUgZ2V0RGV2aWNlc0ZvclVzZXIgTW9vbmJlYW0gQXBwc3luYyBBUEkgZW5kcG9pbnQuXG4gICAgICAgICAgICBjb25zdCBkZXZpY2VzRm9yVXNlclJlc3BvbnNlOiBVc2VyRGV2aWNlc1Jlc3BvbnNlID0gYXdhaXQgbW9vbmJlYW1DbGllbnQuZ2V0RGV2aWNlc0ZvclVzZXIoe1xuICAgICAgICAgICAgICAgIGlkOiBtaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZS5pZFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogY2hlY2sgdG8gc2VlIGlmIHRoZSBnZXQgZGV2aWNlcyBmb3IgdXNlciBjYWxsIHdhcyBzdWNjZXNzZnVsIG9yIG5vdC5cbiAgICAgICAgICAgICAqXG4gICAgICAgICAgICAgKiB3ZSBhbHNvIGNvbnNpZGVyIHRoZSBmYWlsdXJlIG1lc3NhZ2UsIGZvciB1c2VycyB3aXRoIG5vIHBoeXNpY2FsIGRldmljZXMuIEluIHRoYXQgY2FzZSB3ZSBvbmx5IHNlbmQgYW5cbiAgICAgICAgICAgICAqIGVtYWlsLlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBpZiAoKGRldmljZXNGb3JVc2VyUmVzcG9uc2UgJiYgIWRldmljZXNGb3JVc2VyUmVzcG9uc2UuZXJyb3JNZXNzYWdlICYmICFkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmVycm9yVHlwZSAmJlxuICAgICAgICAgICAgICAgIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZGF0YSAmJiBkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmRhdGEubGVuZ3RoICE9PSAwKSB8fFxuICAgICAgICAgICAgICAgIChkZXZpY2VzRm9yVXNlclJlc3BvbnNlICYmIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZXJyb3JUeXBlICE9PSBudWxsICYmIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZXJyb3JUeXBlICE9PSB1bmRlZmluZWQgJiZcbiAgICAgICAgICAgICAgICBkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmVycm9yVHlwZSA9PT0gVXNlckRldmljZUVycm9yVHlwZS5Ob25lT3JBYnNlbnQpKSB7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBkZXZpY2VUb2tlbklkczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgICAgICAgICBpZiAoZGV2aWNlc0ZvclVzZXJSZXNwb25zZSAmJiBkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmVycm9yVHlwZSAhPT0gbnVsbCAmJiBkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmVycm9yVHlwZSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICAgICAgICAgICAgICAgIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZXJyb3JUeXBlID09PSBVc2VyRGV2aWNlRXJyb3JUeXBlLk5vbmVPckFic2VudCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTm8gcGh5c2ljYWwgZGV2aWNlcyBmb3VuZCBmb3IgdXNlciAke21pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLmlkfWApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmRhdGEgIT09IG51bGwgJiYgZGV2aWNlc0ZvclVzZXJSZXNwb25zZS5kYXRhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIDIpIEZpbHRlciBvYnRhaW5lZCBkZXZpY2VzIGJhc2VkIG9uIHRoZWlyIHN0YXR1cyAob25seSBjb25zaWRlciB0aGUgb25lcyB0aGF0IGFyZSBBQ1RJVkUgZm9yIHRoZSB1c2VyKS5cbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdXNlckRldmljZSBvZiBkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyRGV2aWNlIS5kZXZpY2VTdGF0ZSA9PT0gVXNlckRldmljZVN0YXRlLkFjdGl2ZSAmJiBkZXZpY2VUb2tlbklkcy5wdXNoKHVzZXJEZXZpY2UhLnRva2VuSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gMykgUmV0cmlldmUgdGhlIGVtYWlsIG9mIGEgdXNlciBiYXNlZCBvbiB0aGVpciBpbmZvcm1hdGlvbiAobmFtZSwgYWRkcmVzcywgYW5kIGJpcnRoZGF5KVxuICAgICAgICAgICAgICAgIGNvbnN0IGVtYWlsRnJvbVVzZXJJbmZvcm1hdGlvblJlc3BvbnNlOiBFbWFpbEZyb21Db2duaXRvUmVzcG9uc2UgPSBhd2FpdCBtb29uYmVhbUNsaWVudC5nZXRFbWFpbEZvclVzZXIobWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGUpO1xuXG4gICAgICAgICAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHRoZSBnZXQgZW1haWwgZm9yIHVzZXIgY2FsbCB3YXMgc3VjY2Vzc2Z1bCBvciBub3RcbiAgICAgICAgICAgICAgICBpZiAoZW1haWxGcm9tVXNlckluZm9ybWF0aW9uUmVzcG9uc2UgJiYgIWVtYWlsRnJvbVVzZXJJbmZvcm1hdGlvblJlc3BvbnNlLmVycm9yTWVzc2FnZSAmJiAhZW1haWxGcm9tVXNlckluZm9ybWF0aW9uUmVzcG9uc2UuZXJyb3JUeXBlICYmXG4gICAgICAgICAgICAgICAgICAgIGVtYWlsRnJvbVVzZXJJbmZvcm1hdGlvblJlc3BvbnNlLmRhdGEgJiYgZW1haWxGcm9tVXNlckluZm9ybWF0aW9uUmVzcG9uc2UuZGF0YS5sZW5ndGggIT09IDApIHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgd2hhdCB0eXBlIG9mIG5vdGlmaWNhdGlvbiB3ZSBoYXZlLCBkZXBlbmRpbmcgb24gdGhlIG1pbGl0YXJ5IHZlcmlmaWNhdGlvbiBzdGF0dXMgdGhhdCB3ZSdyZSB0cmFuc2l0aW9uaW5nIHRvXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvblR5cGU6IE5vdGlmaWNhdGlvblR5cGUgfCBudWxsID0gKFxuICAgICAgICAgICAgICAgICAgICAgICAgbWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGUub3JpZ2luYWxNaWxpdGFyeVZlcmlmaWNhdGlvblN0YXR1cyA9PT0gTWlsaXRhcnlWZXJpZmljYXRpb25TdGF0dXNUeXBlLlBlbmRpbmcgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLm5ld01pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzID09PSBNaWxpdGFyeVZlcmlmaWNhdGlvblN0YXR1c1R5cGUuVmVyaWZpZWRcbiAgICAgICAgICAgICAgICAgICAgKSA/IE5vdGlmaWNhdGlvblR5cGUuTWlsaXRhcnlTdGF0dXNDaGFuZ2VkUGVuZGluZ1RvVmVyaWZpZWQgOlxuICAgICAgICAgICAgICAgICAgICAgICAgKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLm9yaWdpbmFsTWlsaXRhcnlWZXJpZmljYXRpb25TdGF0dXMgPT09IE1pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzVHlwZS5QZW5kaW5nICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGUubmV3TWlsaXRhcnlWZXJpZmljYXRpb25TdGF0dXMgPT09IE1pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzVHlwZS5SZWplY3RlZFxuICAgICAgICAgICAgICAgICAgICAgICAgKSA/IE5vdGlmaWNhdGlvblR5cGUuTWlsaXRhcnlTdGF0dXNDaGFuZ2VkUGVuZGluZ1RvUmVqZWN0ZWQgOiBudWxsO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChub3RpZmljYXRpb25UeXBlICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyA0KSBDYWxsIHRoZSBjcmVhdGVOb3RpZmljYXRpb24gTW9vbmJlYW0gQXBwU3luYyBBUEkgZW5kcG9pbnQgdG8gY3JlYXRlIGFuIGVtYWlsIG5vdGlmaWNhdGlvbiBmb3IgdGhlIG1pbGl0YXJ5IHN0YXR1cyB1cGRhdGVcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNyZWF0ZUVtYWlsTm90aWZpY2F0aW9uUmVzcG9uc2U6IENyZWF0ZU5vdGlmaWNhdGlvblJlc3BvbnNlID0gYXdhaXQgbW9vbmJlYW1DbGllbnQuY3JlYXRlTm90aWZpY2F0aW9uKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogbWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGUuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbm90aWZpY2F0aW9uVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsVHlwZTogTm90aWZpY2F0aW9uQ2hhbm5lbFR5cGUuRW1haWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlckZ1bGxOYW1lOiBgJHttaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZS5maXJzdE5hbWV9ICR7bWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGUubGFzdE5hbWV9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWFpbERlc3RpbmF0aW9uOiBlbWFpbEZyb21Vc2VySW5mb3JtYXRpb25SZXNwb25zZS5kYXRhISxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IE5vdGlmaWNhdGlvblN0YXR1cy5TZW50XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHRoZSBlbWFpbCBub3RpZmljYXRpb24gY2FsbCB3YXMgc3VjY2Vzc2Z1bCBvciBub3RcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjcmVhdGVFbWFpbE5vdGlmaWNhdGlvblJlc3BvbnNlICYmICFjcmVhdGVFbWFpbE5vdGlmaWNhdGlvblJlc3BvbnNlLmVycm9yTWVzc2FnZSAmJiAhY3JlYXRlRW1haWxOb3RpZmljYXRpb25SZXNwb25zZS5lcnJvclR5cGUgJiYgY3JlYXRlRW1haWxOb3RpZmljYXRpb25SZXNwb25zZS5kYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYE5vdGlmaWNhdGlvbiBlbWFpbCBldmVudCBzdWNjZXNzZnVsbHkgcHJvY2Vzc2VkLCB3aXRoIG5vdGlmaWNhdGlvbiBpZCAke2NyZWF0ZUVtYWlsTm90aWZpY2F0aW9uUmVzcG9uc2UuZGF0YS5ub3RpZmljYXRpb25JZH1gKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlIGFyZSB1c2VyIGFzc29jaWF0ZWQgcGh5c2ljYWwgZGV2aWNlcyB0aGF0IGFyZSBhY3RpdmUsIHRvIHNlbmQgbm90aWZpY2F0aW9ucyB0bywgdGhlbiBwcm9jZWVkIGFjY29yZGluZ2x5XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRldmljZVRva2VuSWRzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA0KSBDYWxsIHRoZSBjcmVhdGVOb3RpZmljYXRpb24gTW9vbmJlYW0gQXBwU3luYyBBUEkgZW5kcG9pbnQgdG8gY3JlYXRlIGEgcHVzaCBub3RpZmljYXRpb24gZm9yIHRoZSBtaWxpdGFyeSBzdGF0dXMgdXBkYXRlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNyZWF0ZVB1c2hOb3RpZmljYXRpb25SZXNwb25zZTogQ3JlYXRlTm90aWZpY2F0aW9uUmVzcG9uc2UgPSBhd2FpdCBtb29uYmVhbUNsaWVudC5jcmVhdGVOb3RpZmljYXRpb24oe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IG1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogbm90aWZpY2F0aW9uVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cG9QdXNoVG9rZW5zOiBkZXZpY2VUb2tlbklkcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWxUeXBlOiBOb3RpZmljYXRpb25DaGFubmVsVHlwZS5QdXNoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBOb3RpZmljYXRpb25TdGF0dXMuU2VudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgdGhlIGVtYWlsIG5vdGlmaWNhdGlvbiBjYWxsIHdhcyBzdWNjZXNzZnVsIG9yIG5vdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3JlYXRlUHVzaE5vdGlmaWNhdGlvblJlc3BvbnNlICYmICFjcmVhdGVQdXNoTm90aWZpY2F0aW9uUmVzcG9uc2UuZXJyb3JNZXNzYWdlICYmICFjcmVhdGVQdXNoTm90aWZpY2F0aW9uUmVzcG9uc2UuZXJyb3JUeXBlICYmIGNyZWF0ZVB1c2hOb3RpZmljYXRpb25SZXNwb25zZS5kYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTm90aWZpY2F0aW9uIHB1c2ggZXZlbnQgc3VjY2Vzc2Z1bGx5IHByb2Nlc3NlZCwgd2l0aCBub3RpZmljYXRpb24gaWQgJHtjcmVhdGVQdXNoTm90aWZpY2F0aW9uUmVzcG9uc2UuZGF0YS5ub3RpZmljYXRpb25JZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBOb3RpZmljYXRpb24gcHVzaCBldmVudCB0aHJvdWdoIENyZWF0ZSBOb3RpZmljYXRpb24gY2FsbCBmYWlsZWRgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkcyBhbiBpdGVtIGZhaWx1cmUsIGZvciB0aGUgU1FTIG1lc3NhZ2Ugd2hpY2ggZmFpbGVkIHByb2Nlc3NpbmcsIGFzIHBhcnQgb2YgdGhlIGluY29taW5nIGV2ZW50XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtRmFpbHVyZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbUlkZW50aWZpZXI6IG1pbGl0YXJ5VmVyaWZpY2F0aW9uVXBkYXRlUmVjb3JkLm1lc3NhZ2VJZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBOb3RpZmljYXRpb24gZW1haWwgZXZlbnQgdGhyb3VnaCBDcmVhdGUgTm90aWZpY2F0aW9uIGNhbGwgZmFpbGVkYCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGRzIGFuIGl0ZW0gZmFpbHVyZSwgZm9yIHRoZSBTUVMgbWVzc2FnZSB3aGljaCBmYWlsZWQgcHJvY2Vzc2luZywgYXMgcGFydCBvZiB0aGUgaW5jb21pbmcgZXZlbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtRmFpbHVyZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1JZGVudGlmaWVyOiBtaWxpdGFyeVZlcmlmaWNhdGlvblVwZGF0ZVJlY29yZC5tZXNzYWdlSWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBJbnZhbGlkIG5vdGlmaWNhdGlvbiB2ZXJpZmljYXRpb24gc3RhdHVzIHRyYW5zaXRpb24gLSAke21pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLm9yaWdpbmFsTWlsaXRhcnlWZXJpZmljYXRpb25TdGF0dXN9IHRvXG4gICAgICAgICAgICAgICAgICAgICAgICAke21pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLm5ld01pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzfSFgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkcyBhbiBpdGVtIGZhaWx1cmUsIGZvciB0aGUgU1FTIG1lc3NhZ2Ugd2hpY2ggZmFpbGVkIHByb2Nlc3NpbmcsIGFzIHBhcnQgb2YgdGhlIGluY29taW5nIGV2ZW50XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtRmFpbHVyZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbUlkZW50aWZpZXI6IG1pbGl0YXJ5VmVyaWZpY2F0aW9uVXBkYXRlUmVjb3JkLm1lc3NhZ2VJZFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVXNlciBlbWFpbCBtYXBwaW5nIHRocm91Z2ggR0VUIGVtYWlsIGZvciB1c2VyIGNhbGwgZmFpbGVkYCk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gYWRkcyBhbiBpdGVtIGZhaWx1cmUsIGZvciB0aGUgU1FTIG1lc3NhZ2Ugd2hpY2ggZmFpbGVkIHByb2Nlc3NpbmcsIGFzIHBhcnQgb2YgdGhlIGluY29taW5nIGV2ZW50XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1GYWlsdXJlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1JZGVudGlmaWVyOiBtaWxpdGFyeVZlcmlmaWNhdGlvblVwZGF0ZVJlY29yZC5tZXNzYWdlSWRcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgUGh5c2ljYWwgRGV2aWNlcyBtYXBwaW5nIHRocm91Z2ggR0VUIGRldmljZXMgZm9yIHVzZXIgY2FsbCBmYWlsZWRgKTtcblxuICAgICAgICAgICAgICAgIC8vIGFkZHMgYW4gaXRlbSBmYWlsdXJlLCBmb3IgdGhlIFNRUyBtZXNzYWdlIHdoaWNoIGZhaWxlZCBwcm9jZXNzaW5nLCBhcyBwYXJ0IG9mIHRoZSBpbmNvbWluZyBldmVudFxuICAgICAgICAgICAgICAgIGl0ZW1GYWlsdXJlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgaXRlbUlkZW50aWZpZXI6IG1pbGl0YXJ5VmVyaWZpY2F0aW9uVXBkYXRlUmVjb3JkLm1lc3NhZ2VJZFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIGZvciB0aGUgTGFtYmRhIHRvIGluZGljYXRlIFNRUyB0aGF0IHRoZXJlIGhhdmUgYmVlbiBubyBmYWlsdXJlcywgYW5kIHRodXMgZW5hYmxlIHRoZSBkZWxldGlvbiBvZiBhbGwgcHJvY2Vzc2VkIG1lc3NhZ2VzXG4gICAgICAgICAqIGZyb20gdGhlIHF1ZXVlLCB3ZSBoYXZlIHRvIHJldHVybiBhbiBlbXB0eSBiYXRjaEl0ZW1GYWlsdXJlcyBhcnJheSBoZXJlLlxuICAgICAgICAgKlxuICAgICAgICAgKiBAbGluayBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vbGFtYmRhL2xhdGVzdC9kZy93aXRoLXNxcy5odG1sXG4gICAgICAgICAqL1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYmF0Y2hJdGVtRmFpbHVyZXM6IGl0ZW1GYWlsdXJlc1xuICAgICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5sb2coYFVuZXhwZWN0ZWQgZXJyb3Igd2hpbGUgcHJvY2Vzc2luZyAke0pTT04uc3RyaW5naWZ5KGV2ZW50KX0gbWlsaXRhcnkgdmVyaWZpY2F0aW9uIHVwZGF0ZSBldmVudCAke2Vycm9yfWApO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiByZXR1cm5zIGEgYmF0Y2ggcmVzcG9uc2UgZmFpbHVyZSBmb3IgdGhlIHBhcnRpY3VsYXIgbWVzc2FnZSBJRHMgd2hpY2ggZmFpbGVkXG4gICAgICAgICAqIGluIHRoaXMgY2FzZSwgdGhlIExhbWJkYSBmdW5jdGlvbiBET0VTIE5PVCBkZWxldGUgdGhlIGluY29taW5nIG1lc3NhZ2VzIGZyb20gdGhlIHF1ZXVlLCBhbmQgaXQgbWFrZXMgaXQgYXZhaWxhYmxlL3Zpc2libGUgYWdhaW5cbiAgICAgICAgICpcbiAgICAgICAgICogQGxpbmsgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvd2l0aC1zcXMuaHRtbFxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGJhdGNoSXRlbUZhaWx1cmVzOiBbe1xuICAgICAgICAgICAgICAgIC8vIGZvciB0aGlzIGNhc2UsIHdlIG9ubHkgcHJvY2VzcyAxIHJlY29yZCBhdCBhIHRpbWUsIHdlIG1pZ2h0IG5lZWQgdG8gY2hhbmdlIHRoaXMgaW4gdGhlIGZ1dHVyZVxuICAgICAgICAgICAgICAgIGl0ZW1JZGVudGlmaWVyOiBldmVudC5SZWNvcmRzWzBdLm1lc3NhZ2VJZFxuICAgICAgICAgICAgfV1cbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==