"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.processMilitaryVerificationUpdate = void 0;
const moonbeam_models_1 = require("@moonbeam/moonbeam-models");
/**
 * MilitaryVerificationUpdatesProcessorHandler handler
 *
 * @param event the {@link SQSEvent} to be processed, containing the military verification update
 * message information
 * @returns {@link Promise} of {@link SQSBatchResponse}
 */
const processMilitaryVerificationUpdate = async (event) => {
    try {
        // retrieving the current function region
        const region = process.env.AWS_REGION;
        /**
         * initializing the batch response, as an empty array, that will be populated with errors, if any throughout the processing
         *
         * for the Lambda to indicate SQS that there have been no failures, and thus enable the deletion of all processed messages
         * from the queue, we have to return an empty batchItemFailures array. If we want to indicate that there have been errors,
         * for each individual message, based on its ID, we have to add it in the final batch response
         *
         * @link https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html
         */
        const itemFailures = [];
        // for each record in the incoming event, repeat the military verification update/notification steps
        for (const militaryVerificationUpdateRecord of event.Records) {
            // first, convert the incoming event message body, into a MilitaryVerificationNotificationUpdate object
            const militaryVerificationNotificationUpdate = JSON.parse(militaryVerificationUpdateRecord.body);
            /**
             * The overall military verification update/notification event processing, will be made up of the following steps:
             *
             * 1) Call the getDevicesForUser Moonbeam AppSync API endpoint, to retrieve all physical devices associated with an
             * incoming user.
             * 2) Filter obtained devices based on their status (only consider the ones that are ACTIVE for the user).
             * 3) Retrieve the email of a user based on their id
             * 4) Call the createNotification Moonbeam AppSync API endpoint, to store the military verification update transaction in Dynamo DB
             * and send the appropriate notification through Courier accordingly (email + push notification).
             */
            // initialize the Moonbeam Client API here, in order to call the appropriate endpoints for this handler
            const moonbeamClient = new moonbeam_models_1.MoonbeamClient(process.env.ENV_NAME, region);
            // 1) Call the getDevicesForUser Moonbeam Appsync API endpoint.
            const devicesForUserResponse = await moonbeamClient.getDevicesForUser({
                id: militaryVerificationNotificationUpdate.id
            });
            // check to see if the get devices for user call was successful or not
            if (devicesForUserResponse && !devicesForUserResponse.errorMessage && !devicesForUserResponse.errorType &&
                devicesForUserResponse.data && devicesForUserResponse.data.length !== 0) {
                // 2) Filter obtained devices based on their status (only consider the ones that are ACTIVE for the user).
                const deviceTokenIds = [];
                for (const userDevice of devicesForUserResponse.data) {
                    userDevice.deviceState === moonbeam_models_1.UserDeviceState.Active && deviceTokenIds.push(userDevice.tokenId);
                }
                // 3) Retrieve the email of a user based on their information (name, address, and birthday)
                const emailFromUserInformationResponse = await moonbeamClient.getEmailForUser(militaryVerificationNotificationUpdate);
                // check to see if the get email for user call was successful or not
                if (emailFromUserInformationResponse && !emailFromUserInformationResponse.errorMessage && !emailFromUserInformationResponse.errorType &&
                    emailFromUserInformationResponse.data && emailFromUserInformationResponse.data.length !== 0) {
                    // determine what type of notification we have, depending on the military verification status that we're transitioning to
                    const notificationType = (militaryVerificationNotificationUpdate.originalMilitaryVerificationStatus === moonbeam_models_1.MilitaryVerificationStatusType.Pending &&
                        militaryVerificationNotificationUpdate.newMilitaryVerificationStatus === moonbeam_models_1.MilitaryVerificationStatusType.Verified) ? moonbeam_models_1.NotificationType.MilitaryStatusChangedPendingToVerified :
                        (militaryVerificationNotificationUpdate.originalMilitaryVerificationStatus === moonbeam_models_1.MilitaryVerificationStatusType.Pending &&
                            militaryVerificationNotificationUpdate.newMilitaryVerificationStatus === moonbeam_models_1.MilitaryVerificationStatusType.Rejected) ? moonbeam_models_1.NotificationType.MilitaryStatusChangedPendingToRejected : null;
                    if (notificationType !== null) {
                        // 4) Call the createNotification Moonbeam AppSync API endpoint to create an email notification for the military status update
                        const createEmailNotificationResponse = await moonbeamClient.createNotification({
                            id: militaryVerificationNotificationUpdate.id,
                            type: notificationType,
                            channelType: moonbeam_models_1.NotificationChannelType.Email,
                            userFullName: `${militaryVerificationNotificationUpdate.firstName} ${militaryVerificationNotificationUpdate.lastName}`,
                            emailDestination: emailFromUserInformationResponse.data,
                            status: moonbeam_models_1.NotificationStatus.Sent
                        });
                        // check to see if the email notification call was successful or not
                        if (createEmailNotificationResponse && !createEmailNotificationResponse.errorMessage && !createEmailNotificationResponse.errorType && createEmailNotificationResponse.data) {
                            console.log(`Notification email event successfully processed, with notification id ${createEmailNotificationResponse.data.notificationId}`);
                            // if there are user associated physical devices that are active, to send notifications to, then proceed accordingly
                            if (deviceTokenIds.length !== 0) {
                                // 4) Call the createNotification Moonbeam AppSync API endpoint to create a push notification for the military status update
                                const createPushNotificationResponse = await moonbeamClient.createNotification({
                                    id: militaryVerificationNotificationUpdate.id,
                                    type: notificationType,
                                    expoPushTokens: deviceTokenIds,
                                    channelType: moonbeam_models_1.NotificationChannelType.Push,
                                    status: moonbeam_models_1.NotificationStatus.Sent
                                });
                                // check to see if the email notification call was successful or not
                                if (createPushNotificationResponse && !createPushNotificationResponse.errorMessage && !createPushNotificationResponse.errorType && createPushNotificationResponse.data) {
                                    console.log(`Notification push event successfully processed, with notification id ${createPushNotificationResponse.data.notificationId}`);
                                }
                                else {
                                    console.log(`Notification push event through Create Notification call failed`);
                                    // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                                    itemFailures.push({
                                        itemIdentifier: militaryVerificationUpdateRecord.messageId
                                    });
                                }
                            }
                        }
                        else {
                            console.log(`Notification email event through Create Notification call failed`);
                            // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                            itemFailures.push({
                                itemIdentifier: militaryVerificationUpdateRecord.messageId
                            });
                        }
                    }
                    else {
                        console.log(`Invalid notification verification status transition - ${militaryVerificationNotificationUpdate.originalMilitaryVerificationStatus} to
                        ${militaryVerificationNotificationUpdate.newMilitaryVerificationStatus}!`);
                        // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                        itemFailures.push({
                            itemIdentifier: militaryVerificationUpdateRecord.messageId
                        });
                    }
                }
                else {
                    console.log(`User email mapping through GET email for user call failed`);
                    // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                    itemFailures.push({
                        itemIdentifier: militaryVerificationUpdateRecord.messageId
                    });
                }
            }
            else {
                console.log(`Physical Devices mapping through GET devices for user call failed`);
                // adds an item failure, for the SQS message which failed processing, as part of the incoming event
                itemFailures.push({
                    itemIdentifier: militaryVerificationUpdateRecord.messageId
                });
            }
        }
        /**
         * for the Lambda to indicate SQS that there have been no failures, and thus enable the deletion of all processed messages
         * from the queue, we have to return an empty batchItemFailures array here.
         *
         * @link https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html
         */
        return {
            batchItemFailures: itemFailures
        };
    }
    catch (error) {
        console.log(`Unexpected error while processing ${JSON.stringify(event)} military verification update event ${error}`);
        /**
         * returns a batch response failure for the particular message IDs which failed
         * in this case, the Lambda function DOES NOT delete the incoming messages from the queue, and it makes it available/visible again
         *
         * @link https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html
         */
        return {
            batchItemFailures: [{
                    // for this case, we only process 1 record at a time, we might need to change this in the future
                    itemIdentifier: event.Records[0].messageId
                }]
        };
    }
};
exports.processMilitaryVerificationUpdate = processMilitaryVerificationUpdate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWlsaXRhcnlWZXJpZmljYXRpb25VcGRhdGVzUHJvY2Vzc29ySGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW1iZGEvaGFuZGxlcnMvTWlsaXRhcnlWZXJpZmljYXRpb25VcGRhdGVzUHJvY2Vzc29ySGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSwrREFTbUM7QUFFbkM7Ozs7OztHQU1HO0FBQ0ksTUFBTSxpQ0FBaUMsR0FBRyxLQUFLLEVBQUUsS0FBZSxFQUE2QixFQUFFO0lBQ2xHLElBQUk7UUFDQSx5Q0FBeUM7UUFDekMsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFXLENBQUM7UUFFdkM7Ozs7Ozs7O1dBUUc7UUFDSCxNQUFNLFlBQVksR0FBMEIsRUFBRSxDQUFDO1FBRS9DLG9HQUFvRztRQUNwRyxLQUFLLE1BQU0sZ0NBQWdDLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUMxRCx1R0FBdUc7WUFDdkcsTUFBTSxzQ0FBc0MsR0FBMkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxJQUFJLENBQTJDLENBQUM7WUFFbkw7Ozs7Ozs7OztlQVNHO1lBQ0MsdUdBQXVHO1lBQzNHLE1BQU0sY0FBYyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUV6RSwrREFBK0Q7WUFDL0QsTUFBTSxzQkFBc0IsR0FBd0IsTUFBTSxjQUFjLENBQUMsaUJBQWlCLENBQUM7Z0JBQ3ZGLEVBQUUsRUFBRSxzQ0FBc0MsQ0FBQyxFQUFFO2FBQ2hELENBQUMsQ0FBQztZQUVILHNFQUFzRTtZQUN0RSxJQUFJLHNCQUFzQixJQUFJLENBQUMsc0JBQXNCLENBQUMsWUFBWSxJQUFJLENBQUMsc0JBQXNCLENBQUMsU0FBUztnQkFDbkcsc0JBQXNCLENBQUMsSUFBSSxJQUFJLHNCQUFzQixDQUFDLElB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Q0o7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNaLE9BQU8sQ0FBQyxHQUFHLENBQUMscUNBQXFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRXRIOzs7OztXQUtHO1FBQ0gsT0FBTztZQUNILGlCQUFpQixFQUFFLENBQUM7b0JBQ2hCLGdHQUFnRztvQkFDaEcsY0FBYyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztpQkFDN0MsQ0FBQztTQUNMLENBQUE7S0FDSjtBQUNMLENBQUMsQ0FBQTtBQXBLWSxRQUFBLGlDQUFpQyxxQ0FvSzdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtTUVNCYXRjaFJlc3BvbnNlLCBTUVNFdmVudH0gZnJvbSBcImF3cy1sYW1iZGFcIjtcbmltcG9ydCB7U1FTQmF0Y2hJdGVtRmFpbHVyZX0gZnJvbSBcImF3cy1sYW1iZGEvdHJpZ2dlci9zcXNcIjtcbmltcG9ydCB7XG4gICAgQ3JlYXRlTm90aWZpY2F0aW9uUmVzcG9uc2UsXG4gICAgRW1haWxGcm9tQ29nbml0b1Jlc3BvbnNlLFxuICAgIE1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLFxuICAgIE1pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzVHlwZSxcbiAgICBNb29uYmVhbUNsaWVudCwgTm90aWZpY2F0aW9uQ2hhbm5lbFR5cGUsIE5vdGlmaWNhdGlvblN0YXR1cyxcbiAgICBOb3RpZmljYXRpb25UeXBlLFxuICAgIFVzZXJEZXZpY2VzUmVzcG9uc2UsXG4gICAgVXNlckRldmljZVN0YXRlXG59IGZyb20gXCJAbW9vbmJlYW0vbW9vbmJlYW0tbW9kZWxzXCI7XG5cbi8qKlxuICogTWlsaXRhcnlWZXJpZmljYXRpb25VcGRhdGVzUHJvY2Vzc29ySGFuZGxlciBoYW5kbGVyXG4gKlxuICogQHBhcmFtIGV2ZW50IHRoZSB7QGxpbmsgU1FTRXZlbnR9IHRvIGJlIHByb2Nlc3NlZCwgY29udGFpbmluZyB0aGUgbWlsaXRhcnkgdmVyaWZpY2F0aW9uIHVwZGF0ZVxuICogbWVzc2FnZSBpbmZvcm1hdGlvblxuICogQHJldHVybnMge0BsaW5rIFByb21pc2V9IG9mIHtAbGluayBTUVNCYXRjaFJlc3BvbnNlfVxuICovXG5leHBvcnQgY29uc3QgcHJvY2Vzc01pbGl0YXJ5VmVyaWZpY2F0aW9uVXBkYXRlID0gYXN5bmMgKGV2ZW50OiBTUVNFdmVudCk6IFByb21pc2U8U1FTQmF0Y2hSZXNwb25zZT4gPT4ge1xuICAgIHRyeSB7XG4gICAgICAgIC8vIHJldHJpZXZpbmcgdGhlIGN1cnJlbnQgZnVuY3Rpb24gcmVnaW9uXG4gICAgICAgIGNvbnN0IHJlZ2lvbiA9IHByb2Nlc3MuZW52LkFXU19SRUdJT04hO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBpbml0aWFsaXppbmcgdGhlIGJhdGNoIHJlc3BvbnNlLCBhcyBhbiBlbXB0eSBhcnJheSwgdGhhdCB3aWxsIGJlIHBvcHVsYXRlZCB3aXRoIGVycm9ycywgaWYgYW55IHRocm91Z2hvdXQgdGhlIHByb2Nlc3NpbmdcbiAgICAgICAgICpcbiAgICAgICAgICogZm9yIHRoZSBMYW1iZGEgdG8gaW5kaWNhdGUgU1FTIHRoYXQgdGhlcmUgaGF2ZSBiZWVuIG5vIGZhaWx1cmVzLCBhbmQgdGh1cyBlbmFibGUgdGhlIGRlbGV0aW9uIG9mIGFsbCBwcm9jZXNzZWQgbWVzc2FnZXNcbiAgICAgICAgICogZnJvbSB0aGUgcXVldWUsIHdlIGhhdmUgdG8gcmV0dXJuIGFuIGVtcHR5IGJhdGNoSXRlbUZhaWx1cmVzIGFycmF5LiBJZiB3ZSB3YW50IHRvIGluZGljYXRlIHRoYXQgdGhlcmUgaGF2ZSBiZWVuIGVycm9ycyxcbiAgICAgICAgICogZm9yIGVhY2ggaW5kaXZpZHVhbCBtZXNzYWdlLCBiYXNlZCBvbiBpdHMgSUQsIHdlIGhhdmUgdG8gYWRkIGl0IGluIHRoZSBmaW5hbCBiYXRjaCByZXNwb25zZVxuICAgICAgICAgKlxuICAgICAgICAgKiBAbGluayBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vbGFtYmRhL2xhdGVzdC9kZy93aXRoLXNxcy5odG1sXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBpdGVtRmFpbHVyZXM6IFNRU0JhdGNoSXRlbUZhaWx1cmVbXSA9IFtdO1xuXG4gICAgICAgIC8vIGZvciBlYWNoIHJlY29yZCBpbiB0aGUgaW5jb21pbmcgZXZlbnQsIHJlcGVhdCB0aGUgbWlsaXRhcnkgdmVyaWZpY2F0aW9uIHVwZGF0ZS9ub3RpZmljYXRpb24gc3RlcHNcbiAgICAgICAgZm9yIChjb25zdCBtaWxpdGFyeVZlcmlmaWNhdGlvblVwZGF0ZVJlY29yZCBvZiBldmVudC5SZWNvcmRzKSB7XG4gICAgICAgICAgICAvLyBmaXJzdCwgY29udmVydCB0aGUgaW5jb21pbmcgZXZlbnQgbWVzc2FnZSBib2R5LCBpbnRvIGEgTWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGUgb2JqZWN0XG4gICAgICAgICAgICBjb25zdCBtaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZTogTWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGUgPSBKU09OLnBhcnNlKG1pbGl0YXJ5VmVyaWZpY2F0aW9uVXBkYXRlUmVjb3JkLmJvZHkpIGFzIE1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlO1xuXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIFRoZSBvdmVyYWxsIG1pbGl0YXJ5IHZlcmlmaWNhdGlvbiB1cGRhdGUvbm90aWZpY2F0aW9uIGV2ZW50IHByb2Nlc3NpbmcsIHdpbGwgYmUgbWFkZSB1cCBvZiB0aGUgZm9sbG93aW5nIHN0ZXBzOlxuICAgICAgICAgICAgICpcbiAgICAgICAgICAgICAqIDEpIENhbGwgdGhlIGdldERldmljZXNGb3JVc2VyIE1vb25iZWFtIEFwcFN5bmMgQVBJIGVuZHBvaW50LCB0byByZXRyaWV2ZSBhbGwgcGh5c2ljYWwgZGV2aWNlcyBhc3NvY2lhdGVkIHdpdGggYW5cbiAgICAgICAgICAgICAqIGluY29taW5nIHVzZXIuXG4gICAgICAgICAgICAgKiAyKSBGaWx0ZXIgb2J0YWluZWQgZGV2aWNlcyBiYXNlZCBvbiB0aGVpciBzdGF0dXMgKG9ubHkgY29uc2lkZXIgdGhlIG9uZXMgdGhhdCBhcmUgQUNUSVZFIGZvciB0aGUgdXNlcikuXG4gICAgICAgICAgICAgKiAzKSBSZXRyaWV2ZSB0aGUgZW1haWwgb2YgYSB1c2VyIGJhc2VkIG9uIHRoZWlyIGlkXG4gICAgICAgICAgICAgKiA0KSBDYWxsIHRoZSBjcmVhdGVOb3RpZmljYXRpb24gTW9vbmJlYW0gQXBwU3luYyBBUEkgZW5kcG9pbnQsIHRvIHN0b3JlIHRoZSBtaWxpdGFyeSB2ZXJpZmljYXRpb24gdXBkYXRlIHRyYW5zYWN0aW9uIGluIER5bmFtbyBEQlxuICAgICAgICAgICAgICogYW5kIHNlbmQgdGhlIGFwcHJvcHJpYXRlIG5vdGlmaWNhdGlvbiB0aHJvdWdoIENvdXJpZXIgYWNjb3JkaW5nbHkgKGVtYWlsICsgcHVzaCBub3RpZmljYXRpb24pLlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZSB0aGUgTW9vbmJlYW0gQ2xpZW50IEFQSSBoZXJlLCBpbiBvcmRlciB0byBjYWxsIHRoZSBhcHByb3ByaWF0ZSBlbmRwb2ludHMgZm9yIHRoaXMgaGFuZGxlclxuICAgICAgICAgICAgY29uc3QgbW9vbmJlYW1DbGllbnQgPSBuZXcgTW9vbmJlYW1DbGllbnQocHJvY2Vzcy5lbnYuRU5WX05BTUUhLCByZWdpb24pO1xuXG4gICAgICAgICAgICAvLyAxKSBDYWxsIHRoZSBnZXREZXZpY2VzRm9yVXNlciBNb29uYmVhbSBBcHBzeW5jIEFQSSBlbmRwb2ludC5cbiAgICAgICAgICAgIGNvbnN0IGRldmljZXNGb3JVc2VyUmVzcG9uc2U6IFVzZXJEZXZpY2VzUmVzcG9uc2UgPSBhd2FpdCBtb29uYmVhbUNsaWVudC5nZXREZXZpY2VzRm9yVXNlcih7XG4gICAgICAgICAgICAgICAgaWQ6IG1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLmlkXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHRoZSBnZXQgZGV2aWNlcyBmb3IgdXNlciBjYWxsIHdhcyBzdWNjZXNzZnVsIG9yIG5vdFxuICAgICAgICAgICAgaWYgKGRldmljZXNGb3JVc2VyUmVzcG9uc2UgJiYgIWRldmljZXNGb3JVc2VyUmVzcG9uc2UuZXJyb3JNZXNzYWdlICYmICFkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmVycm9yVHlwZSAmJlxuICAgICAgICAgICAgICAgIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZGF0YSAmJiBkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmRhdGEubGVuZ3RoICE9PSAwKSB7XG5cbiAgICAgICAgICAgICAgICAvLyAyKSBGaWx0ZXIgb2J0YWluZWQgZGV2aWNlcyBiYXNlZCBvbiB0aGVpciBzdGF0dXMgKG9ubHkgY29uc2lkZXIgdGhlIG9uZXMgdGhhdCBhcmUgQUNUSVZFIGZvciB0aGUgdXNlcikuXG4gICAgICAgICAgICAgICAgY29uc3QgZGV2aWNlVG9rZW5JZHM6IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCB1c2VyRGV2aWNlIG9mIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICB1c2VyRGV2aWNlIS5kZXZpY2VTdGF0ZSA9PT0gVXNlckRldmljZVN0YXRlLkFjdGl2ZSAmJiBkZXZpY2VUb2tlbklkcy5wdXNoKHVzZXJEZXZpY2UhLnRva2VuSWQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIDMpIFJldHJpZXZlIHRoZSBlbWFpbCBvZiBhIHVzZXIgYmFzZWQgb24gdGhlaXIgaW5mb3JtYXRpb24gKG5hbWUsIGFkZHJlc3MsIGFuZCBiaXJ0aGRheSlcbiAgICAgICAgICAgICAgICBjb25zdCBlbWFpbEZyb21Vc2VySW5mb3JtYXRpb25SZXNwb25zZTogRW1haWxGcm9tQ29nbml0b1Jlc3BvbnNlID0gYXdhaXQgbW9vbmJlYW1DbGllbnQuZ2V0RW1haWxGb3JVc2VyKG1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlKTtcblxuICAgICAgICAgICAgICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB0aGUgZ2V0IGVtYWlsIGZvciB1c2VyIGNhbGwgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90XG4gICAgICAgICAgICAgICAgaWYgKGVtYWlsRnJvbVVzZXJJbmZvcm1hdGlvblJlc3BvbnNlICYmICFlbWFpbEZyb21Vc2VySW5mb3JtYXRpb25SZXNwb25zZS5lcnJvck1lc3NhZ2UgJiYgIWVtYWlsRnJvbVVzZXJJbmZvcm1hdGlvblJlc3BvbnNlLmVycm9yVHlwZSAmJlxuICAgICAgICAgICAgICAgICAgICBlbWFpbEZyb21Vc2VySW5mb3JtYXRpb25SZXNwb25zZS5kYXRhICYmIGVtYWlsRnJvbVVzZXJJbmZvcm1hdGlvblJlc3BvbnNlLmRhdGEubGVuZ3RoICE9PSAwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIHdoYXQgdHlwZSBvZiBub3RpZmljYXRpb24gd2UgaGF2ZSwgZGVwZW5kaW5nIG9uIHRoZSBtaWxpdGFyeSB2ZXJpZmljYXRpb24gc3RhdHVzIHRoYXQgd2UncmUgdHJhbnNpdGlvbmluZyB0b1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RpZmljYXRpb25UeXBlOiBOb3RpZmljYXRpb25UeXBlIHwgbnVsbCA9IChcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLm9yaWdpbmFsTWlsaXRhcnlWZXJpZmljYXRpb25TdGF0dXMgPT09IE1pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzVHlwZS5QZW5kaW5nICYmXG4gICAgICAgICAgICAgICAgICAgICAgICBtaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZS5uZXdNaWxpdGFyeVZlcmlmaWNhdGlvblN0YXR1cyA9PT0gTWlsaXRhcnlWZXJpZmljYXRpb25TdGF0dXNUeXBlLlZlcmlmaWVkXG4gICAgICAgICAgICAgICAgICAgICkgPyBOb3RpZmljYXRpb25UeXBlLk1pbGl0YXJ5U3RhdHVzQ2hhbmdlZFBlbmRpbmdUb1ZlcmlmaWVkIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZS5vcmlnaW5hbE1pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzID09PSBNaWxpdGFyeVZlcmlmaWNhdGlvblN0YXR1c1R5cGUuUGVuZGluZyAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLm5ld01pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzID09PSBNaWxpdGFyeVZlcmlmaWNhdGlvblN0YXR1c1R5cGUuUmVqZWN0ZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICkgPyBOb3RpZmljYXRpb25UeXBlLk1pbGl0YXJ5U3RhdHVzQ2hhbmdlZFBlbmRpbmdUb1JlamVjdGVkIDogbnVsbDtcblxuICAgICAgICAgICAgICAgICAgICBpZiAobm90aWZpY2F0aW9uVHlwZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gNCkgQ2FsbCB0aGUgY3JlYXRlTm90aWZpY2F0aW9uIE1vb25iZWFtIEFwcFN5bmMgQVBJIGVuZHBvaW50IHRvIGNyZWF0ZSBhbiBlbWFpbCBub3RpZmljYXRpb24gZm9yIHRoZSBtaWxpdGFyeSBzdGF0dXMgdXBkYXRlXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVhdGVFbWFpbE5vdGlmaWNhdGlvblJlc3BvbnNlOiBDcmVhdGVOb3RpZmljYXRpb25SZXNwb25zZSA9IGF3YWl0IG1vb25iZWFtQ2xpZW50LmNyZWF0ZU5vdGlmaWNhdGlvbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IG1pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5vdGlmaWNhdGlvblR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbFR5cGU6IE5vdGlmaWNhdGlvbkNoYW5uZWxUeXBlLkVtYWlsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJGdWxsTmFtZTogYCR7bWlsaXRhcnlWZXJpZmljYXRpb25Ob3RpZmljYXRpb25VcGRhdGUuZmlyc3ROYW1lfSAke21pbGl0YXJ5VmVyaWZpY2F0aW9uTm90aWZpY2F0aW9uVXBkYXRlLmxhc3ROYW1lfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1haWxEZXN0aW5hdGlvbjogZW1haWxGcm9tVXNlckluZm9ybWF0aW9uUmVzcG9uc2UuZGF0YSEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBOb3RpZmljYXRpb25TdGF0dXMuU2VudFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIHRvIHNlZSBpZiB0aGUgZW1haWwgbm90aWZpY2F0aW9uIGNhbGwgd2FzIHN1Y2Nlc3NmdWwgb3Igbm90XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3JlYXRlRW1haWxOb3RpZmljYXRpb25SZXNwb25zZSAmJiAhY3JlYXRlRW1haWxOb3RpZmljYXRpb25SZXNwb25zZS5lcnJvck1lc3NhZ2UgJiYgIWNyZWF0ZUVtYWlsTm90aWZpY2F0aW9uUmVzcG9uc2UuZXJyb3JUeXBlICYmIGNyZWF0ZUVtYWlsTm90aWZpY2F0aW9uUmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBOb3RpZmljYXRpb24gZW1haWwgZXZlbnQgc3VjY2Vzc2Z1bGx5IHByb2Nlc3NlZCwgd2l0aCBub3RpZmljYXRpb24gaWQgJHtjcmVhdGVFbWFpbE5vdGlmaWNhdGlvblJlc3BvbnNlLmRhdGEubm90aWZpY2F0aW9uSWR9YCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBhcmUgdXNlciBhc3NvY2lhdGVkIHBoeXNpY2FsIGRldmljZXMgdGhhdCBhcmUgYWN0aXZlLCB0byBzZW5kIG5vdGlmaWNhdGlvbnMgdG8sIHRoZW4gcHJvY2VlZCBhY2NvcmRpbmdseVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXZpY2VUb2tlbklkcy5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNCkgQ2FsbCB0aGUgY3JlYXRlTm90aWZpY2F0aW9uIE1vb25iZWFtIEFwcFN5bmMgQVBJIGVuZHBvaW50IHRvIGNyZWF0ZSBhIHB1c2ggbm90aWZpY2F0aW9uIGZvciB0aGUgbWlsaXRhcnkgc3RhdHVzIHVwZGF0ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVhdGVQdXNoTm90aWZpY2F0aW9uUmVzcG9uc2U6IENyZWF0ZU5vdGlmaWNhdGlvblJlc3BvbnNlID0gYXdhaXQgbW9vbmJlYW1DbGllbnQuY3JlYXRlTm90aWZpY2F0aW9uKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBtaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IG5vdGlmaWNhdGlvblR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBvUHVzaFRva2VuczogZGV2aWNlVG9rZW5JZHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsVHlwZTogTm90aWZpY2F0aW9uQ2hhbm5lbFR5cGUuUHVzaCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogTm90aWZpY2F0aW9uU3RhdHVzLlNlbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHRoZSBlbWFpbCBub3RpZmljYXRpb24gY2FsbCB3YXMgc3VjY2Vzc2Z1bCBvciBub3RcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNyZWF0ZVB1c2hOb3RpZmljYXRpb25SZXNwb25zZSAmJiAhY3JlYXRlUHVzaE5vdGlmaWNhdGlvblJlc3BvbnNlLmVycm9yTWVzc2FnZSAmJiAhY3JlYXRlUHVzaE5vdGlmaWNhdGlvblJlc3BvbnNlLmVycm9yVHlwZSAmJiBjcmVhdGVQdXNoTm90aWZpY2F0aW9uUmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYE5vdGlmaWNhdGlvbiBwdXNoIGV2ZW50IHN1Y2Nlc3NmdWxseSBwcm9jZXNzZWQsIHdpdGggbm90aWZpY2F0aW9uIGlkICR7Y3JlYXRlUHVzaE5vdGlmaWNhdGlvblJlc3BvbnNlLmRhdGEubm90aWZpY2F0aW9uSWR9YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTm90aWZpY2F0aW9uIHB1c2ggZXZlbnQgdGhyb3VnaCBDcmVhdGUgTm90aWZpY2F0aW9uIGNhbGwgZmFpbGVkYCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZHMgYW4gaXRlbSBmYWlsdXJlLCBmb3IgdGhlIFNRUyBtZXNzYWdlIHdoaWNoIGZhaWxlZCBwcm9jZXNzaW5nLCBhcyBwYXJ0IG9mIHRoZSBpbmNvbWluZyBldmVudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbUZhaWx1cmVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1JZGVudGlmaWVyOiBtaWxpdGFyeVZlcmlmaWNhdGlvblVwZGF0ZVJlY29yZC5tZXNzYWdlSWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTm90aWZpY2F0aW9uIGVtYWlsIGV2ZW50IHRocm91Z2ggQ3JlYXRlIE5vdGlmaWNhdGlvbiBjYWxsIGZhaWxlZGApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkcyBhbiBpdGVtIGZhaWx1cmUsIGZvciB0aGUgU1FTIG1lc3NhZ2Ugd2hpY2ggZmFpbGVkIHByb2Nlc3NpbmcsIGFzIHBhcnQgb2YgdGhlIGluY29taW5nIGV2ZW50XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbUZhaWx1cmVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtSWRlbnRpZmllcjogbWlsaXRhcnlWZXJpZmljYXRpb25VcGRhdGVSZWNvcmQubWVzc2FnZUlkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSW52YWxpZCBub3RpZmljYXRpb24gdmVyaWZpY2F0aW9uIHN0YXR1cyB0cmFuc2l0aW9uIC0gJHttaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZS5vcmlnaW5hbE1pbGl0YXJ5VmVyaWZpY2F0aW9uU3RhdHVzfSB0b1xuICAgICAgICAgICAgICAgICAgICAgICAgJHttaWxpdGFyeVZlcmlmaWNhdGlvbk5vdGlmaWNhdGlvblVwZGF0ZS5uZXdNaWxpdGFyeVZlcmlmaWNhdGlvblN0YXR1c30hYCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZHMgYW4gaXRlbSBmYWlsdXJlLCBmb3IgdGhlIFNRUyBtZXNzYWdlIHdoaWNoIGZhaWxlZCBwcm9jZXNzaW5nLCBhcyBwYXJ0IG9mIHRoZSBpbmNvbWluZyBldmVudFxuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbUZhaWx1cmVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1JZGVudGlmaWVyOiBtaWxpdGFyeVZlcmlmaWNhdGlvblVwZGF0ZVJlY29yZC5tZXNzYWdlSWRcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFVzZXIgZW1haWwgbWFwcGluZyB0aHJvdWdoIEdFVCBlbWFpbCBmb3IgdXNlciBjYWxsIGZhaWxlZGApO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIGFkZHMgYW4gaXRlbSBmYWlsdXJlLCBmb3IgdGhlIFNRUyBtZXNzYWdlIHdoaWNoIGZhaWxlZCBwcm9jZXNzaW5nLCBhcyBwYXJ0IG9mIHRoZSBpbmNvbWluZyBldmVudFxuICAgICAgICAgICAgICAgICAgICBpdGVtRmFpbHVyZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtSWRlbnRpZmllcjogbWlsaXRhcnlWZXJpZmljYXRpb25VcGRhdGVSZWNvcmQubWVzc2FnZUlkXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFBoeXNpY2FsIERldmljZXMgbWFwcGluZyB0aHJvdWdoIEdFVCBkZXZpY2VzIGZvciB1c2VyIGNhbGwgZmFpbGVkYCk7XG5cbiAgICAgICAgICAgICAgICAvLyBhZGRzIGFuIGl0ZW0gZmFpbHVyZSwgZm9yIHRoZSBTUVMgbWVzc2FnZSB3aGljaCBmYWlsZWQgcHJvY2Vzc2luZywgYXMgcGFydCBvZiB0aGUgaW5jb21pbmcgZXZlbnRcbiAgICAgICAgICAgICAgICBpdGVtRmFpbHVyZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1JZGVudGlmaWVyOiBtaWxpdGFyeVZlcmlmaWNhdGlvblVwZGF0ZVJlY29yZC5tZXNzYWdlSWRcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBmb3IgdGhlIExhbWJkYSB0byBpbmRpY2F0ZSBTUVMgdGhhdCB0aGVyZSBoYXZlIGJlZW4gbm8gZmFpbHVyZXMsIGFuZCB0aHVzIGVuYWJsZSB0aGUgZGVsZXRpb24gb2YgYWxsIHByb2Nlc3NlZCBtZXNzYWdlc1xuICAgICAgICAgKiBmcm9tIHRoZSBxdWV1ZSwgd2UgaGF2ZSB0byByZXR1cm4gYW4gZW1wdHkgYmF0Y2hJdGVtRmFpbHVyZXMgYXJyYXkgaGVyZS5cbiAgICAgICAgICpcbiAgICAgICAgICogQGxpbmsgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvZGcvd2l0aC1zcXMuaHRtbFxuICAgICAgICAgKi9cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGJhdGNoSXRlbUZhaWx1cmVzOiBpdGVtRmFpbHVyZXNcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBVbmV4cGVjdGVkIGVycm9yIHdoaWxlIHByb2Nlc3NpbmcgJHtKU09OLnN0cmluZ2lmeShldmVudCl9IG1pbGl0YXJ5IHZlcmlmaWNhdGlvbiB1cGRhdGUgZXZlbnQgJHtlcnJvcn1gKTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogcmV0dXJucyBhIGJhdGNoIHJlc3BvbnNlIGZhaWx1cmUgZm9yIHRoZSBwYXJ0aWN1bGFyIG1lc3NhZ2UgSURzIHdoaWNoIGZhaWxlZFxuICAgICAgICAgKiBpbiB0aGlzIGNhc2UsIHRoZSBMYW1iZGEgZnVuY3Rpb24gRE9FUyBOT1QgZGVsZXRlIHRoZSBpbmNvbWluZyBtZXNzYWdlcyBmcm9tIHRoZSBxdWV1ZSwgYW5kIGl0IG1ha2VzIGl0IGF2YWlsYWJsZS92aXNpYmxlIGFnYWluXG4gICAgICAgICAqXG4gICAgICAgICAqIEBsaW5rIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9sYW1iZGEvbGF0ZXN0L2RnL3dpdGgtc3FzLmh0bWxcbiAgICAgICAgICovXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBiYXRjaEl0ZW1GYWlsdXJlczogW3tcbiAgICAgICAgICAgICAgICAvLyBmb3IgdGhpcyBjYXNlLCB3ZSBvbmx5IHByb2Nlc3MgMSByZWNvcmQgYXQgYSB0aW1lLCB3ZSBtaWdodCBuZWVkIHRvIGNoYW5nZSB0aGlzIGluIHRoZSBmdXR1cmVcbiAgICAgICAgICAgICAgICBpdGVtSWRlbnRpZmllcjogZXZlbnQuUmVjb3Jkc1swXS5tZXNzYWdlSWRcbiAgICAgICAgICAgIH1dXG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=