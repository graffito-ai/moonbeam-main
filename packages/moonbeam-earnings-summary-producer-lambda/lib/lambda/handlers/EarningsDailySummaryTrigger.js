"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.triggerEarningsDailySummariesCreation = void 0;
const moonbeam_models_1 = require("@moonbeam/moonbeam-models");
/**
 * Function used to handle the earnings daily summary trigger, by determining
 * which users spent in a particular day, creating a summary for them, and then sending
 * them a PUSH and EMAIL notification.
 *
 * @returns a {@link Promise} of {@link void}, since the EventBridger
 * event trigger, will execute a cron job and not return anything.
 */
const triggerEarningsDailySummariesCreation = async () => {
    /**
     * The overall daily earnings summary cron triggering, will be made up of the following steps:
     *
     * 1) We want to get the previous day's date, and set that as our target date in the next step.
     * 2) Call the createDailyEarningsSummary AppSync Mutation API in order to determine which users
     * spent in the previous day, and create a summary for them.
     *
     * For each one of the summary reports created that day:
     * 3) Call the getDevicesForUser Moonbeam Appsync API endpoint.
     * 4) Filter obtained devices based on their status (only consider the ones that are ACTIVE for the user).
     * 5) Retrieve the email of a user based on their userId.
     * 6) Call the createNotification Moonbeam AppSync API endpoint to create an email notification for the daily earnings summary update.
     * 7) Call the createNotification Moonbeam AppSync API endpoint to create a push notification for the daily earnings summary update.
     */
    try {
        // retrieving the current function region
        const region = process.env.AWS_REGION;
        // 1) We want to get the previous day's date, and set that as our target date in the next step.
        const todayDate = new Date();
        const targetDate = new Date();
        // set the targetDate as yesterday's date at 00:00:00.000Z
        targetDate.setDate(todayDate.getDate() - 1);
        targetDate.setHours(0);
        targetDate.setMinutes(0);
        targetDate.setSeconds(0);
        targetDate.setMilliseconds(0);
        // initialize the Moonbeam Client API here, in order to call the appropriate endpoints for this handler
        const moonbeamClient = new moonbeam_models_1.MoonbeamClient(process.env.ENV_NAME, region);
        /**
         * 2) Call the createDailyEarningsSummary AppSync Mutation API in order to determine which users
         * spent in the previous day, and create a summary for them.
         */
        const dailyEarningsSummaryResponse = await moonbeamClient.createDailyEarningsSummary({
            targetDate: new Date(targetDate.setUTCHours(0, 0, 0, 0)).toISOString()
        });
        // make sure that creating the daily earnings summaries call was successful or not
        if (dailyEarningsSummaryResponse && !dailyEarningsSummaryResponse.errorMessage && !dailyEarningsSummaryResponse.errorType &&
            dailyEarningsSummaryResponse.data && dailyEarningsSummaryResponse.data.length !== 0) {
            // For each one of the summary reports created that day proceed to steps 3,4,5,6 and 7
            for (const dailyEarningsSummary of dailyEarningsSummaryResponse.data) {
                if (dailyEarningsSummary !== null) {
                    // 3) Call the getDevicesForUser Moonbeam Appsync API endpoint.
                    const devicesForUserResponse = await moonbeamClient.getDevicesForUser({
                        id: dailyEarningsSummary.id
                    });
                    /**
                     * check to see if the get devices for user call was successful or not.
                     *
                     * we also consider the failure message, for users with no physical devices. In that case we only send an
                     * email.
                     */
                    if ((devicesForUserResponse && !devicesForUserResponse.errorMessage && !devicesForUserResponse.errorType &&
                        devicesForUserResponse.data && devicesForUserResponse.data.length !== 0) ||
                        (devicesForUserResponse && devicesForUserResponse.errorType !== null && devicesForUserResponse.errorType !== undefined &&
                            devicesForUserResponse.errorType === moonbeam_models_1.UserDeviceErrorType.NoneOrAbsent)) {
                        const deviceTokenIds = [];
                        if (devicesForUserResponse && devicesForUserResponse.errorType !== null && devicesForUserResponse.errorType !== undefined &&
                            devicesForUserResponse.errorType === moonbeam_models_1.UserDeviceErrorType.NoneOrAbsent) {
                            console.log(`No physical devices found for user ${dailyEarningsSummary.id}`);
                        }
                        else {
                            if (devicesForUserResponse.data !== null && devicesForUserResponse.data !== undefined) {
                                // 4) Filter obtained devices based on their status (only consider the ones that are ACTIVE for the user).
                                for (const userDevice of devicesForUserResponse.data) {
                                    userDevice.deviceState === moonbeam_models_1.UserDeviceState.Active && deviceTokenIds.push(userDevice.tokenId);
                                }
                            }
                        }
                        // 5) Retrieve the email of a user based on their userId.
                        const emailFromUserInformationResponse = await moonbeamClient.getEmailByUserId(dailyEarningsSummary.id);
                        // check to see if the get email for user call was successful or not
                        if (emailFromUserInformationResponse && !emailFromUserInformationResponse.errorMessage && !emailFromUserInformationResponse.errorType &&
                            emailFromUserInformationResponse.data && emailFromUserInformationResponse.data.length !== 0) {
                            // compute the dailyEarningsSummaryAmount from the summary transactions
                            let dailyEarningsSummaryAmount = 0;
                            dailyEarningsSummary.transactions.forEach(transaction => {
                                if (transaction !== null) {
                                    dailyEarningsSummaryAmount += transaction.rewardAmount;
                                }
                            });
                            dailyEarningsSummaryAmount = Number(dailyEarningsSummaryAmount.toFixed(2));
                            // 6) Call the createNotification Moonbeam AppSync API endpoint to create an email notification for the daily earnings summary update
                            const createEmailNotificationResponse = await moonbeamClient.createNotification({
                                id: dailyEarningsSummary.id,
                                type: moonbeam_models_1.NotificationType.DailyEarningsSummary,
                                channelType: moonbeam_models_1.NotificationChannelType.Email,
                                userFullName: `Placeholder`,
                                emailDestination: emailFromUserInformationResponse.data,
                                dailyEarningsSummaryAmount: dailyEarningsSummaryAmount,
                                transactions: dailyEarningsSummary.transactions,
                                status: moonbeam_models_1.NotificationStatus.Sent
                            });
                            // check to see if the email notification call was successful or not
                            if (createEmailNotificationResponse && !createEmailNotificationResponse.errorMessage && !createEmailNotificationResponse.errorType && createEmailNotificationResponse.data) {
                                console.log(`Notification email event successfully processed, with notification id ${createEmailNotificationResponse.data.notificationId}`);
                                // if there are user associated physical devices that are active, to send notifications to, then proceed accordingly
                                if (deviceTokenIds.length !== 0) {
                                    // 7) Call the createNotification Moonbeam AppSync API endpoint to create a push notification for the daily earnings summary update
                                    const createPushNotificationResponse = await moonbeamClient.createNotification({
                                        id: dailyEarningsSummary.id,
                                        type: moonbeam_models_1.NotificationType.DailyEarningsSummary,
                                        expoPushTokens: deviceTokenIds,
                                        channelType: moonbeam_models_1.NotificationChannelType.Push,
                                        dailyEarningsSummaryAmount: dailyEarningsSummaryAmount,
                                        status: moonbeam_models_1.NotificationStatus.Sent
                                    });
                                    // check to see if the email notification call was successful or not
                                    if (createPushNotificationResponse && !createPushNotificationResponse.errorMessage && !createPushNotificationResponse.errorType && createPushNotificationResponse.data) {
                                        console.log(`Notification push event successfully processed, with notification id ${createPushNotificationResponse.data.notificationId}`);
                                    }
                                    else {
                                        console.log(`Notification push event through Create Notification call failed`);
                                    }
                                }
                            }
                            else {
                                console.log(`Notification email event through Create Notification call failed`);
                            }
                        }
                        else {
                            console.log(`User email mapping through GET email for user call failed`);
                        }
                    }
                    else {
                        console.log(`Physical Devices mapping through GET devices for user call failed`);
                    }
                }
            }
        }
        else {
            // check if there are no daily summaries needed to get generated first
            if (dailyEarningsSummaryResponse.errorType && dailyEarningsSummaryResponse.errorType === moonbeam_models_1.DailySummaryErrorType.NoneOrAbsent &&
                dailyEarningsSummaryResponse.data && dailyEarningsSummaryResponse.data.length === 0) {
                /**
                 * no need for further actions, since this error will be logged and nothing will execute further.
                 * in the future we might need some alerts and metrics emitting here
                 */
                const errorMessage = `Creating daily summaries through the createDailyEarningsSummary call failed`;
                console.log(errorMessage);
            }
            else {
                /**
                 * no need for further actions, since this error will be logged and nothing will execute further.
                 * in the future we might need some alerts and metrics emitting here
                 */
                const errorMessage = `Creating daily summaries through the createDailyEarningsSummary call failed`;
                console.log(errorMessage);
            }
        }
    }
    catch (error) {
        /**
         * no need for further actions, since this error will be logged and nothing will execute further.
         * in the future we might need some alerts and metrics emitting here
         */
        console.log(`Unexpected error while processing the daily earnings summary cron event ${error}`);
    }
};
exports.triggerEarningsDailySummariesCreation = triggerEarningsDailySummariesCreation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRWFybmluZ3NEYWlseVN1bW1hcnlUcmlnZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xhbWJkYS9oYW5kbGVycy9FYXJuaW5nc0RhaWx5U3VtbWFyeVRyaWdnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0RBWW1DO0FBRW5DOzs7Ozs7O0dBT0c7QUFDSSxNQUFNLHFDQUFxQyxHQUFHLEtBQUssSUFBbUIsRUFBRTtJQUMzRTs7Ozs7Ozs7Ozs7OztPQWFHO0lBQ0gsSUFBSTtRQUNBLHlDQUF5QztRQUN6QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVcsQ0FBQztRQUV2QywrRkFBK0Y7UUFDL0YsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUM3QixNQUFNLFVBQVUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBRTlCLDBEQUEwRDtRQUMxRCxVQUFVLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUM1QyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QixVQUFVLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTlCLHVHQUF1RztRQUN2RyxNQUFNLGNBQWMsR0FBRyxJQUFJLGdDQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFekU7OztXQUdHO1FBQ0gsTUFBTSw0QkFBNEIsR0FBaUMsTUFBTSxjQUFjLENBQUMsMEJBQTBCLENBQUM7WUFDL0csVUFBVSxFQUFFLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUU7U0FDdEUsQ0FBQyxDQUFDO1FBRUgsa0ZBQWtGO1FBQ2xGLElBQUksNEJBQTRCLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxZQUFZLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxTQUFTO1lBQ3JILDRCQUE0QixDQUFDLElBQUksSUFBSSw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNyRixzRkFBc0Y7WUFDdEYsS0FBSyxNQUFNLG9CQUFvQixJQUFJLDRCQUE0QixDQUFDLElBQUksRUFBRTtnQkFDbEUsSUFBSSxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7b0JBQy9CLCtEQUErRDtvQkFDL0QsTUFBTSxzQkFBc0IsR0FBd0IsTUFBTSxjQUFjLENBQUMsaUJBQWlCLENBQUM7d0JBQ3ZGLEVBQUUsRUFBRSxvQkFBb0IsQ0FBQyxFQUFFO3FCQUM5QixDQUFDLENBQUM7b0JBRUg7Ozs7O3VCQUtHO29CQUNILElBQUksQ0FBQyxzQkFBc0IsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFlBQVksSUFBSSxDQUFDLHNCQUFzQixDQUFDLFNBQVM7d0JBQ2hHLHNCQUFzQixDQUFDLElBQUksSUFBSSxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQzt3QkFDNUUsQ0FBQyxzQkFBc0IsSUFBSSxzQkFBc0IsQ0FBQyxTQUFTLEtBQUssSUFBSSxJQUFJLHNCQUFzQixDQUFDLFNBQVMsS0FBSyxTQUFTOzRCQUNsSCxzQkFBc0IsQ0FBQyxTQUFTLEtBQUsscUNBQW1CLENBQUMsWUFBWSxDQUFDLEVBQUU7d0JBRTVFLE1BQU0sY0FBYyxHQUFhLEVBQUUsQ0FBQzt3QkFDcEMsSUFBSSxzQkFBc0IsSUFBSSxzQkFBc0IsQ0FBQyxTQUFTLEtBQUssSUFBSSxJQUFJLHNCQUFzQixDQUFDLFNBQVMsS0FBSyxTQUFTOzRCQUNySCxzQkFBc0IsQ0FBQyxTQUFTLEtBQUsscUNBQW1CLENBQUMsWUFBWSxFQUFFOzRCQUN2RSxPQUFPLENBQUMsR0FBRyxDQUFDLHNDQUFzQyxvQkFBb0IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO3lCQUNoRjs2QkFBTTs0QkFDSCxJQUFJLHNCQUFzQixDQUFDLElBQUksS0FBSyxJQUFJLElBQUksc0JBQXNCLENBQUMsSUFBSSxLQUFLLFNBQVMsRUFBRTtnQ0FDbkYsMEdBQTBHO2dDQUMxRyxLQUFLLE1BQU0sVUFBVSxJQUFJLHNCQUFzQixDQUFDLElBQUksRUFBRTtvQ0FDbEQsVUFBVyxDQUFDLFdBQVcsS0FBSyxpQ0FBZSxDQUFDLE1BQU0sSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLFVBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztpQ0FDbEc7NkJBQ0o7eUJBQ0o7d0JBRUQseURBQXlEO3dCQUN6RCxNQUFNLGdDQUFnQyxHQUE2QixNQUFNLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFFbEksb0VBQW9FO3dCQUNwRSxJQUFJLGdDQUFnQyxJQUFJLENBQUMsZ0NBQWdDLENBQUMsWUFBWSxJQUFJLENBQUMsZ0NBQWdDLENBQUMsU0FBUzs0QkFDakksZ0NBQWdDLENBQUMsSUFBSSxJQUFJLGdDQUFnQyxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFOzRCQUM3Rix1RUFBdUU7NEJBQ3ZFLElBQUksMEJBQTBCLEdBQUcsQ0FBQyxDQUFDOzRCQUNuQyxvQkFBb0IsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFO2dDQUNwRCxJQUFJLFdBQVcsS0FBSyxJQUFJLEVBQUU7b0NBQ3RCLDBCQUEwQixJQUFJLFdBQVcsQ0FBQyxZQUFZLENBQUM7aUNBQzFEOzRCQUNMLENBQUMsQ0FBQyxDQUFDOzRCQUNILDBCQUEwQixHQUFHLE1BQU0sQ0FBQywwQkFBMEIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFFM0UscUlBQXFJOzRCQUNySSxNQUFNLCtCQUErQixHQUErQixNQUFNLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQztnQ0FDeEcsRUFBRSxFQUFFLG9CQUFvQixDQUFDLEVBQUU7Z0NBQzNCLElBQUksRUFBRSxrQ0FBZ0IsQ0FBQyxvQkFBb0I7Z0NBQzNDLFdBQVcsRUFBRSx5Q0FBdUIsQ0FBQyxLQUFLO2dDQUMxQyxZQUFZLEVBQUUsYUFBYTtnQ0FDM0IsZ0JBQWdCLEVBQUUsZ0NBQWdDLENBQUMsSUFBSztnQ0FDeEQsMEJBQTBCLEVBQUUsMEJBQTBCO2dDQUN0RCxZQUFZLEVBQUUsb0JBQW9CLENBQUMsWUFBWTtnQ0FDL0MsTUFBTSxFQUFFLG9DQUFrQixDQUFDLElBQUk7NkJBQ2xDLENBQUMsQ0FBQzs0QkFFSCxvRUFBb0U7NEJBQ3BFLElBQUksK0JBQStCLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxZQUFZLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxTQUFTLElBQUksK0JBQStCLENBQUMsSUFBSSxFQUFFO2dDQUN4SyxPQUFPLENBQUMsR0FBRyxDQUFDLHlFQUF5RSwrQkFBK0IsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztnQ0FFNUksb0hBQW9IO2dDQUNwSCxJQUFJLGNBQWMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29DQUM3QixtSUFBbUk7b0NBQ25JLE1BQU0sOEJBQThCLEdBQStCLE1BQU0sY0FBYyxDQUFDLGtCQUFrQixDQUFDO3dDQUN2RyxFQUFFLEVBQUUsb0JBQW9CLENBQUMsRUFBRTt3Q0FDM0IsSUFBSSxFQUFFLGtDQUFnQixDQUFDLG9CQUFvQjt3Q0FDM0MsY0FBYyxFQUFFLGNBQWM7d0NBQzlCLFdBQVcsRUFBRSx5Q0FBdUIsQ0FBQyxJQUFJO3dDQUN6QywwQkFBMEIsRUFBRSwwQkFBMEI7d0NBQ3RELE1BQU0sRUFBRSxvQ0FBa0IsQ0FBQyxJQUFJO3FDQUNsQyxDQUFDLENBQUM7b0NBRUgsb0VBQW9FO29DQUNwRSxJQUFJLDhCQUE4QixJQUFJLENBQUMsOEJBQThCLENBQUMsWUFBWSxJQUFJLENBQUMsOEJBQThCLENBQUMsU0FBUyxJQUFJLDhCQUE4QixDQUFDLElBQUksRUFBRTt3Q0FDcEssT0FBTyxDQUFDLEdBQUcsQ0FBQyx3RUFBd0UsOEJBQThCLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7cUNBQzdJO3lDQUFNO3dDQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsaUVBQWlFLENBQUMsQ0FBQztxQ0FDbEY7aUNBQ0o7NkJBQ0o7aUNBQU07Z0NBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrRUFBa0UsQ0FBQyxDQUFDOzZCQUNuRjt5QkFFSjs2QkFBTTs0QkFDSCxPQUFPLENBQUMsR0FBRyxDQUFDLDJEQUEyRCxDQUFDLENBQUM7eUJBQzVFO3FCQUNKO3lCQUFNO3dCQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsbUVBQW1FLENBQUMsQ0FBQztxQkFDcEY7aUJBQ0o7YUFDSjtTQUNKO2FBQU07WUFDSCxzRUFBc0U7WUFDdEUsSUFBSSw0QkFBNEIsQ0FBQyxTQUFTLElBQUksNEJBQTRCLENBQUMsU0FBUyxLQUFLLHVDQUFxQixDQUFDLFlBQVk7Z0JBQ3ZILDRCQUE0QixDQUFDLElBQUksSUFBSSw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDckY7OzttQkFHRztnQkFDSCxNQUFNLFlBQVksR0FBRyw2RUFBNkUsQ0FBQztnQkFDbkcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUM3QjtpQkFBTTtnQkFDSDs7O21CQUdHO2dCQUNILE1BQU0sWUFBWSxHQUFHLDZFQUE2RSxDQUFDO2dCQUNuRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO2FBQzdCO1NBQ0o7S0FDSjtJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ1o7OztXQUdHO1FBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQywyRUFBMkUsS0FBSyxFQUFFLENBQUMsQ0FBQztLQUNuRztBQUNMLENBQUMsQ0FBQTtBQXBLWSxRQUFBLHFDQUFxQyx5Q0FvS2pEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBDcmVhdGVOb3RpZmljYXRpb25SZXNwb25zZSxcbiAgICBEYWlseUVhcm5pbmdzU3VtbWFyeVJlc3BvbnNlLFxuICAgIERhaWx5U3VtbWFyeUVycm9yVHlwZSxcbiAgICBFbWFpbEZyb21Db2duaXRvUmVzcG9uc2UsXG4gICAgTW9vbmJlYW1DbGllbnQsXG4gICAgTm90aWZpY2F0aW9uQ2hhbm5lbFR5cGUsXG4gICAgTm90aWZpY2F0aW9uU3RhdHVzLFxuICAgIE5vdGlmaWNhdGlvblR5cGUsXG4gICAgVXNlckRldmljZUVycm9yVHlwZSxcbiAgICBVc2VyRGV2aWNlc1Jlc3BvbnNlLFxuICAgIFVzZXJEZXZpY2VTdGF0ZVxufSBmcm9tIFwiQG1vb25iZWFtL21vb25iZWFtLW1vZGVsc1wiO1xuXG4vKipcbiAqIEZ1bmN0aW9uIHVzZWQgdG8gaGFuZGxlIHRoZSBlYXJuaW5ncyBkYWlseSBzdW1tYXJ5IHRyaWdnZXIsIGJ5IGRldGVybWluaW5nXG4gKiB3aGljaCB1c2VycyBzcGVudCBpbiBhIHBhcnRpY3VsYXIgZGF5LCBjcmVhdGluZyBhIHN1bW1hcnkgZm9yIHRoZW0sIGFuZCB0aGVuIHNlbmRpbmdcbiAqIHRoZW0gYSBQVVNIIGFuZCBFTUFJTCBub3RpZmljYXRpb24uXG4gKlxuICogQHJldHVybnMgYSB7QGxpbmsgUHJvbWlzZX0gb2Yge0BsaW5rIHZvaWR9LCBzaW5jZSB0aGUgRXZlbnRCcmlkZ2VyXG4gKiBldmVudCB0cmlnZ2VyLCB3aWxsIGV4ZWN1dGUgYSBjcm9uIGpvYiBhbmQgbm90IHJldHVybiBhbnl0aGluZy5cbiAqL1xuZXhwb3J0IGNvbnN0IHRyaWdnZXJFYXJuaW5nc0RhaWx5U3VtbWFyaWVzQ3JlYXRpb24gPSBhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgLyoqXG4gICAgICogVGhlIG92ZXJhbGwgZGFpbHkgZWFybmluZ3Mgc3VtbWFyeSBjcm9uIHRyaWdnZXJpbmcsIHdpbGwgYmUgbWFkZSB1cCBvZiB0aGUgZm9sbG93aW5nIHN0ZXBzOlxuICAgICAqXG4gICAgICogMSkgV2Ugd2FudCB0byBnZXQgdGhlIHByZXZpb3VzIGRheSdzIGRhdGUsIGFuZCBzZXQgdGhhdCBhcyBvdXIgdGFyZ2V0IGRhdGUgaW4gdGhlIG5leHQgc3RlcC5cbiAgICAgKiAyKSBDYWxsIHRoZSBjcmVhdGVEYWlseUVhcm5pbmdzU3VtbWFyeSBBcHBTeW5jIE11dGF0aW9uIEFQSSBpbiBvcmRlciB0byBkZXRlcm1pbmUgd2hpY2ggdXNlcnNcbiAgICAgKiBzcGVudCBpbiB0aGUgcHJldmlvdXMgZGF5LCBhbmQgY3JlYXRlIGEgc3VtbWFyeSBmb3IgdGhlbS5cbiAgICAgKlxuICAgICAqIEZvciBlYWNoIG9uZSBvZiB0aGUgc3VtbWFyeSByZXBvcnRzIGNyZWF0ZWQgdGhhdCBkYXk6XG4gICAgICogMykgQ2FsbCB0aGUgZ2V0RGV2aWNlc0ZvclVzZXIgTW9vbmJlYW0gQXBwc3luYyBBUEkgZW5kcG9pbnQuXG4gICAgICogNCkgRmlsdGVyIG9idGFpbmVkIGRldmljZXMgYmFzZWQgb24gdGhlaXIgc3RhdHVzIChvbmx5IGNvbnNpZGVyIHRoZSBvbmVzIHRoYXQgYXJlIEFDVElWRSBmb3IgdGhlIHVzZXIpLlxuICAgICAqIDUpIFJldHJpZXZlIHRoZSBlbWFpbCBvZiBhIHVzZXIgYmFzZWQgb24gdGhlaXIgdXNlcklkLlxuICAgICAqIDYpIENhbGwgdGhlIGNyZWF0ZU5vdGlmaWNhdGlvbiBNb29uYmVhbSBBcHBTeW5jIEFQSSBlbmRwb2ludCB0byBjcmVhdGUgYW4gZW1haWwgbm90aWZpY2F0aW9uIGZvciB0aGUgZGFpbHkgZWFybmluZ3Mgc3VtbWFyeSB1cGRhdGUuXG4gICAgICogNykgQ2FsbCB0aGUgY3JlYXRlTm90aWZpY2F0aW9uIE1vb25iZWFtIEFwcFN5bmMgQVBJIGVuZHBvaW50IHRvIGNyZWF0ZSBhIHB1c2ggbm90aWZpY2F0aW9uIGZvciB0aGUgZGFpbHkgZWFybmluZ3Mgc3VtbWFyeSB1cGRhdGUuXG4gICAgICovXG4gICAgdHJ5IHtcbiAgICAgICAgLy8gcmV0cmlldmluZyB0aGUgY3VycmVudCBmdW5jdGlvbiByZWdpb25cbiAgICAgICAgY29uc3QgcmVnaW9uID0gcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiE7XG5cbiAgICAgICAgLy8gMSkgV2Ugd2FudCB0byBnZXQgdGhlIHByZXZpb3VzIGRheSdzIGRhdGUsIGFuZCBzZXQgdGhhdCBhcyBvdXIgdGFyZ2V0IGRhdGUgaW4gdGhlIG5leHQgc3RlcC5cbiAgICAgICAgY29uc3QgdG9kYXlEYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgY29uc3QgdGFyZ2V0RGF0ZSA9IG5ldyBEYXRlKCk7XG5cbiAgICAgICAgLy8gc2V0IHRoZSB0YXJnZXREYXRlIGFzIHllc3RlcmRheSdzIGRhdGUgYXQgMDA6MDA6MDAuMDAwWlxuICAgICAgICB0YXJnZXREYXRlLnNldERhdGUodG9kYXlEYXRlLmdldERhdGUoKSAtIDEpO1xuICAgICAgICB0YXJnZXREYXRlLnNldEhvdXJzKDApO1xuICAgICAgICB0YXJnZXREYXRlLnNldE1pbnV0ZXMoMCk7XG4gICAgICAgIHRhcmdldERhdGUuc2V0U2Vjb25kcygwKTtcbiAgICAgICAgdGFyZ2V0RGF0ZS5zZXRNaWxsaXNlY29uZHMoMCk7XG5cbiAgICAgICAgLy8gaW5pdGlhbGl6ZSB0aGUgTW9vbmJlYW0gQ2xpZW50IEFQSSBoZXJlLCBpbiBvcmRlciB0byBjYWxsIHRoZSBhcHByb3ByaWF0ZSBlbmRwb2ludHMgZm9yIHRoaXMgaGFuZGxlclxuICAgICAgICBjb25zdCBtb29uYmVhbUNsaWVudCA9IG5ldyBNb29uYmVhbUNsaWVudChwcm9jZXNzLmVudi5FTlZfTkFNRSEsIHJlZ2lvbik7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIDIpIENhbGwgdGhlIGNyZWF0ZURhaWx5RWFybmluZ3NTdW1tYXJ5IEFwcFN5bmMgTXV0YXRpb24gQVBJIGluIG9yZGVyIHRvIGRldGVybWluZSB3aGljaCB1c2Vyc1xuICAgICAgICAgKiBzcGVudCBpbiB0aGUgcHJldmlvdXMgZGF5LCBhbmQgY3JlYXRlIGEgc3VtbWFyeSBmb3IgdGhlbS5cbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IGRhaWx5RWFybmluZ3NTdW1tYXJ5UmVzcG9uc2U6IERhaWx5RWFybmluZ3NTdW1tYXJ5UmVzcG9uc2UgPSBhd2FpdCBtb29uYmVhbUNsaWVudC5jcmVhdGVEYWlseUVhcm5pbmdzU3VtbWFyeSh7XG4gICAgICAgICAgICB0YXJnZXREYXRlOiBuZXcgRGF0ZSh0YXJnZXREYXRlLnNldFVUQ0hvdXJzKDAsMCwwLDApKS50b0lTT1N0cmluZygpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IGNyZWF0aW5nIHRoZSBkYWlseSBlYXJuaW5ncyBzdW1tYXJpZXMgY2FsbCB3YXMgc3VjY2Vzc2Z1bCBvciBub3RcbiAgICAgICAgaWYgKGRhaWx5RWFybmluZ3NTdW1tYXJ5UmVzcG9uc2UgJiYgIWRhaWx5RWFybmluZ3NTdW1tYXJ5UmVzcG9uc2UuZXJyb3JNZXNzYWdlICYmICFkYWlseUVhcm5pbmdzU3VtbWFyeVJlc3BvbnNlLmVycm9yVHlwZSAmJlxuICAgICAgICAgICAgZGFpbHlFYXJuaW5nc1N1bW1hcnlSZXNwb25zZS5kYXRhICYmIGRhaWx5RWFybmluZ3NTdW1tYXJ5UmVzcG9uc2UuZGF0YS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgIC8vIEZvciBlYWNoIG9uZSBvZiB0aGUgc3VtbWFyeSByZXBvcnRzIGNyZWF0ZWQgdGhhdCBkYXkgcHJvY2VlZCB0byBzdGVwcyAzLDQsNSw2IGFuZCA3XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGRhaWx5RWFybmluZ3NTdW1tYXJ5IG9mIGRhaWx5RWFybmluZ3NTdW1tYXJ5UmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgICAgIGlmIChkYWlseUVhcm5pbmdzU3VtbWFyeSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAvLyAzKSBDYWxsIHRoZSBnZXREZXZpY2VzRm9yVXNlciBNb29uYmVhbSBBcHBzeW5jIEFQSSBlbmRwb2ludC5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGV2aWNlc0ZvclVzZXJSZXNwb25zZTogVXNlckRldmljZXNSZXNwb25zZSA9IGF3YWl0IG1vb25iZWFtQ2xpZW50LmdldERldmljZXNGb3JVc2VyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkYWlseUVhcm5pbmdzU3VtbWFyeS5pZFxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICAgICAgICogY2hlY2sgdG8gc2VlIGlmIHRoZSBnZXQgZGV2aWNlcyBmb3IgdXNlciBjYWxsIHdhcyBzdWNjZXNzZnVsIG9yIG5vdC5cbiAgICAgICAgICAgICAgICAgICAgICpcbiAgICAgICAgICAgICAgICAgICAgICogd2UgYWxzbyBjb25zaWRlciB0aGUgZmFpbHVyZSBtZXNzYWdlLCBmb3IgdXNlcnMgd2l0aCBubyBwaHlzaWNhbCBkZXZpY2VzLiBJbiB0aGF0IGNhc2Ugd2Ugb25seSBzZW5kIGFuXG4gICAgICAgICAgICAgICAgICAgICAqIGVtYWlsLlxuICAgICAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICAgICAgaWYgKChkZXZpY2VzRm9yVXNlclJlc3BvbnNlICYmICFkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmVycm9yTWVzc2FnZSAmJiAhZGV2aWNlc0ZvclVzZXJSZXNwb25zZS5lcnJvclR5cGUgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmRhdGEgJiYgZGV2aWNlc0ZvclVzZXJSZXNwb25zZS5kYXRhLmxlbmd0aCAhPT0gMCkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIChkZXZpY2VzRm9yVXNlclJlc3BvbnNlICYmIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZXJyb3JUeXBlICE9PSBudWxsICYmIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZXJyb3JUeXBlICE9PSB1bmRlZmluZWQgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmVycm9yVHlwZSA9PT0gVXNlckRldmljZUVycm9yVHlwZS5Ob25lT3JBYnNlbnQpKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRldmljZVRva2VuSWRzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRldmljZXNGb3JVc2VyUmVzcG9uc2UgJiYgZGV2aWNlc0ZvclVzZXJSZXNwb25zZS5lcnJvclR5cGUgIT09IG51bGwgJiYgZGV2aWNlc0ZvclVzZXJSZXNwb25zZS5lcnJvclR5cGUgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZXNGb3JVc2VyUmVzcG9uc2UuZXJyb3JUeXBlID09PSBVc2VyRGV2aWNlRXJyb3JUeXBlLk5vbmVPckFic2VudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBObyBwaHlzaWNhbCBkZXZpY2VzIGZvdW5kIGZvciB1c2VyICR7ZGFpbHlFYXJuaW5nc1N1bW1hcnkuaWR9YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXZpY2VzRm9yVXNlclJlc3BvbnNlLmRhdGEgIT09IG51bGwgJiYgZGV2aWNlc0ZvclVzZXJSZXNwb25zZS5kYXRhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNCkgRmlsdGVyIG9idGFpbmVkIGRldmljZXMgYmFzZWQgb24gdGhlaXIgc3RhdHVzIChvbmx5IGNvbnNpZGVyIHRoZSBvbmVzIHRoYXQgYXJlIEFDVElWRSBmb3IgdGhlIHVzZXIpLlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHVzZXJEZXZpY2Ugb2YgZGV2aWNlc0ZvclVzZXJSZXNwb25zZS5kYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyRGV2aWNlIS5kZXZpY2VTdGF0ZSA9PT0gVXNlckRldmljZVN0YXRlLkFjdGl2ZSAmJiBkZXZpY2VUb2tlbklkcy5wdXNoKHVzZXJEZXZpY2UhLnRva2VuSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyA1KSBSZXRyaWV2ZSB0aGUgZW1haWwgb2YgYSB1c2VyIGJhc2VkIG9uIHRoZWlyIHVzZXJJZC5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVtYWlsRnJvbVVzZXJJbmZvcm1hdGlvblJlc3BvbnNlOiBFbWFpbEZyb21Db2duaXRvUmVzcG9uc2UgPSBhd2FpdCBtb29uYmVhbUNsaWVudC5nZXRFbWFpbEJ5VXNlcklkKGRhaWx5RWFybmluZ3NTdW1tYXJ5LmlkKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHRoZSBnZXQgZW1haWwgZm9yIHVzZXIgY2FsbCB3YXMgc3VjY2Vzc2Z1bCBvciBub3RcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbWFpbEZyb21Vc2VySW5mb3JtYXRpb25SZXNwb25zZSAmJiAhZW1haWxGcm9tVXNlckluZm9ybWF0aW9uUmVzcG9uc2UuZXJyb3JNZXNzYWdlICYmICFlbWFpbEZyb21Vc2VySW5mb3JtYXRpb25SZXNwb25zZS5lcnJvclR5cGUgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWFpbEZyb21Vc2VySW5mb3JtYXRpb25SZXNwb25zZS5kYXRhICYmIGVtYWlsRnJvbVVzZXJJbmZvcm1hdGlvblJlc3BvbnNlLmRhdGEubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29tcHV0ZSB0aGUgZGFpbHlFYXJuaW5nc1N1bW1hcnlBbW91bnQgZnJvbSB0aGUgc3VtbWFyeSB0cmFuc2FjdGlvbnNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGFpbHlFYXJuaW5nc1N1bW1hcnlBbW91bnQgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhaWx5RWFybmluZ3NTdW1tYXJ5LnRyYW5zYWN0aW9ucy5mb3JFYWNoKHRyYW5zYWN0aW9uID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zYWN0aW9uICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYWlseUVhcm5pbmdzU3VtbWFyeUFtb3VudCArPSB0cmFuc2FjdGlvbi5yZXdhcmRBbW91bnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYWlseUVhcm5pbmdzU3VtbWFyeUFtb3VudCA9IE51bWJlcihkYWlseUVhcm5pbmdzU3VtbWFyeUFtb3VudC50b0ZpeGVkKDIpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDYpIENhbGwgdGhlIGNyZWF0ZU5vdGlmaWNhdGlvbiBNb29uYmVhbSBBcHBTeW5jIEFQSSBlbmRwb2ludCB0byBjcmVhdGUgYW4gZW1haWwgbm90aWZpY2F0aW9uIGZvciB0aGUgZGFpbHkgZWFybmluZ3Mgc3VtbWFyeSB1cGRhdGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVhdGVFbWFpbE5vdGlmaWNhdGlvblJlc3BvbnNlOiBDcmVhdGVOb3RpZmljYXRpb25SZXNwb25zZSA9IGF3YWl0IG1vb25iZWFtQ2xpZW50LmNyZWF0ZU5vdGlmaWNhdGlvbih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBkYWlseUVhcm5pbmdzU3VtbWFyeS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogTm90aWZpY2F0aW9uVHlwZS5EYWlseUVhcm5pbmdzU3VtbWFyeSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbFR5cGU6IE5vdGlmaWNhdGlvbkNoYW5uZWxUeXBlLkVtYWlsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyRnVsbE5hbWU6IGBQbGFjZWhvbGRlcmAsIC8vIHdlIGJhY2stZmlsbCB0aGlzIGFzIGEgcGxhY2Vob2xkZXIsIGFzIGl0IHdvbid0IGJlIG5lZWRlZCBmb3IgdGhpcyB0eXBlIG9mIGVtYWlsIG5vdGlmaWNhdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWFpbERlc3RpbmF0aW9uOiBlbWFpbEZyb21Vc2VySW5mb3JtYXRpb25SZXNwb25zZS5kYXRhISxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGFpbHlFYXJuaW5nc1N1bW1hcnlBbW91bnQ6IGRhaWx5RWFybmluZ3NTdW1tYXJ5QW1vdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbnM6IGRhaWx5RWFybmluZ3NTdW1tYXJ5LnRyYW5zYWN0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiBOb3RpZmljYXRpb25TdGF0dXMuU2VudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgdG8gc2VlIGlmIHRoZSBlbWFpbCBub3RpZmljYXRpb24gY2FsbCB3YXMgc3VjY2Vzc2Z1bCBvciBub3RcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3JlYXRlRW1haWxOb3RpZmljYXRpb25SZXNwb25zZSAmJiAhY3JlYXRlRW1haWxOb3RpZmljYXRpb25SZXNwb25zZS5lcnJvck1lc3NhZ2UgJiYgIWNyZWF0ZUVtYWlsTm90aWZpY2F0aW9uUmVzcG9uc2UuZXJyb3JUeXBlICYmIGNyZWF0ZUVtYWlsTm90aWZpY2F0aW9uUmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTm90aWZpY2F0aW9uIGVtYWlsIGV2ZW50IHN1Y2Nlc3NmdWxseSBwcm9jZXNzZWQsIHdpdGggbm90aWZpY2F0aW9uIGlkICR7Y3JlYXRlRW1haWxOb3RpZmljYXRpb25SZXNwb25zZS5kYXRhLm5vdGlmaWNhdGlvbklkfWApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlIGFyZSB1c2VyIGFzc29jaWF0ZWQgcGh5c2ljYWwgZGV2aWNlcyB0aGF0IGFyZSBhY3RpdmUsIHRvIHNlbmQgbm90aWZpY2F0aW9ucyB0bywgdGhlbiBwcm9jZWVkIGFjY29yZGluZ2x5XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXZpY2VUb2tlbklkcy5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDcpIENhbGwgdGhlIGNyZWF0ZU5vdGlmaWNhdGlvbiBNb29uYmVhbSBBcHBTeW5jIEFQSSBlbmRwb2ludCB0byBjcmVhdGUgYSBwdXNoIG5vdGlmaWNhdGlvbiBmb3IgdGhlIGRhaWx5IGVhcm5pbmdzIHN1bW1hcnkgdXBkYXRlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjcmVhdGVQdXNoTm90aWZpY2F0aW9uUmVzcG9uc2U6IENyZWF0ZU5vdGlmaWNhdGlvblJlc3BvbnNlID0gYXdhaXQgbW9vbmJlYW1DbGllbnQuY3JlYXRlTm90aWZpY2F0aW9uKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogZGFpbHlFYXJuaW5nc1N1bW1hcnkuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogTm90aWZpY2F0aW9uVHlwZS5EYWlseUVhcm5pbmdzU3VtbWFyeSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBvUHVzaFRva2VuczogZGV2aWNlVG9rZW5JZHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbFR5cGU6IE5vdGlmaWNhdGlvbkNoYW5uZWxUeXBlLlB1c2gsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGFpbHlFYXJuaW5nc1N1bW1hcnlBbW91bnQ6IGRhaWx5RWFybmluZ3NTdW1tYXJ5QW1vdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogTm90aWZpY2F0aW9uU3RhdHVzLlNlbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgdGhlIGVtYWlsIG5vdGlmaWNhdGlvbiBjYWxsIHdhcyBzdWNjZXNzZnVsIG9yIG5vdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNyZWF0ZVB1c2hOb3RpZmljYXRpb25SZXNwb25zZSAmJiAhY3JlYXRlUHVzaE5vdGlmaWNhdGlvblJlc3BvbnNlLmVycm9yTWVzc2FnZSAmJiAhY3JlYXRlUHVzaE5vdGlmaWNhdGlvblJlc3BvbnNlLmVycm9yVHlwZSAmJiBjcmVhdGVQdXNoTm90aWZpY2F0aW9uUmVzcG9uc2UuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBOb3RpZmljYXRpb24gcHVzaCBldmVudCBzdWNjZXNzZnVsbHkgcHJvY2Vzc2VkLCB3aXRoIG5vdGlmaWNhdGlvbiBpZCAke2NyZWF0ZVB1c2hOb3RpZmljYXRpb25SZXNwb25zZS5kYXRhLm5vdGlmaWNhdGlvbklkfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTm90aWZpY2F0aW9uIHB1c2ggZXZlbnQgdGhyb3VnaCBDcmVhdGUgTm90aWZpY2F0aW9uIGNhbGwgZmFpbGVkYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTm90aWZpY2F0aW9uIGVtYWlsIGV2ZW50IHRocm91Z2ggQ3JlYXRlIE5vdGlmaWNhdGlvbiBjYWxsIGZhaWxlZGApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVXNlciBlbWFpbCBtYXBwaW5nIHRocm91Z2ggR0VUIGVtYWlsIGZvciB1c2VyIGNhbGwgZmFpbGVkYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgUGh5c2ljYWwgRGV2aWNlcyBtYXBwaW5nIHRocm91Z2ggR0VUIGRldmljZXMgZm9yIHVzZXIgY2FsbCBmYWlsZWRgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBubyBkYWlseSBzdW1tYXJpZXMgbmVlZGVkIHRvIGdldCBnZW5lcmF0ZWQgZmlyc3RcbiAgICAgICAgICAgIGlmIChkYWlseUVhcm5pbmdzU3VtbWFyeVJlc3BvbnNlLmVycm9yVHlwZSAmJiBkYWlseUVhcm5pbmdzU3VtbWFyeVJlc3BvbnNlLmVycm9yVHlwZSA9PT0gRGFpbHlTdW1tYXJ5RXJyb3JUeXBlLk5vbmVPckFic2VudCAmJlxuICAgICAgICAgICAgICAgIGRhaWx5RWFybmluZ3NTdW1tYXJ5UmVzcG9uc2UuZGF0YSAmJiBkYWlseUVhcm5pbmdzU3VtbWFyeVJlc3BvbnNlLmRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogbm8gbmVlZCBmb3IgZnVydGhlciBhY3Rpb25zLCBzaW5jZSB0aGlzIGVycm9yIHdpbGwgYmUgbG9nZ2VkIGFuZCBub3RoaW5nIHdpbGwgZXhlY3V0ZSBmdXJ0aGVyLlxuICAgICAgICAgICAgICAgICAqIGluIHRoZSBmdXR1cmUgd2UgbWlnaHQgbmVlZCBzb21lIGFsZXJ0cyBhbmQgbWV0cmljcyBlbWl0dGluZyBoZXJlXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYENyZWF0aW5nIGRhaWx5IHN1bW1hcmllcyB0aHJvdWdoIHRoZSBjcmVhdGVEYWlseUVhcm5pbmdzU3VtbWFyeSBjYWxsIGZhaWxlZGA7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogbm8gbmVlZCBmb3IgZnVydGhlciBhY3Rpb25zLCBzaW5jZSB0aGlzIGVycm9yIHdpbGwgYmUgbG9nZ2VkIGFuZCBub3RoaW5nIHdpbGwgZXhlY3V0ZSBmdXJ0aGVyLlxuICAgICAgICAgICAgICAgICAqIGluIHRoZSBmdXR1cmUgd2UgbWlnaHQgbmVlZCBzb21lIGFsZXJ0cyBhbmQgbWV0cmljcyBlbWl0dGluZyBoZXJlXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYENyZWF0aW5nIGRhaWx5IHN1bW1hcmllcyB0aHJvdWdoIHRoZSBjcmVhdGVEYWlseUVhcm5pbmdzU3VtbWFyeSBjYWxsIGZhaWxlZGA7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBubyBuZWVkIGZvciBmdXJ0aGVyIGFjdGlvbnMsIHNpbmNlIHRoaXMgZXJyb3Igd2lsbCBiZSBsb2dnZWQgYW5kIG5vdGhpbmcgd2lsbCBleGVjdXRlIGZ1cnRoZXIuXG4gICAgICAgICAqIGluIHRoZSBmdXR1cmUgd2UgbWlnaHQgbmVlZCBzb21lIGFsZXJ0cyBhbmQgbWV0cmljcyBlbWl0dGluZyBoZXJlXG4gICAgICAgICAqL1xuICAgICAgICBjb25zb2xlLmxvZyhgVW5leHBlY3RlZCBlcnJvciB3aGlsZSBwcm9jZXNzaW5nIHRoZSBkYWlseSBlYXJuaW5ncyBzdW1tYXJ5IGNyb24gZXZlbnQgJHtlcnJvcn1gKTtcbiAgICB9XG59XG4iXX0=